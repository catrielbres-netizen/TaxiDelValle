<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chofer - Taxi del Valle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- FORMATO CONGELADO: NO MODIFICAR (COPIADO DE CLIENTE) --- */
        body { font-family: 'Inter', sans-serif; }
        .btn-active { background-color: #FBBF24; color: #1F2937; cursor: pointer; opacity: 1; transition: background-color 0.2s; }
        .btn-active:hover:not(:disabled) { background-color: #F59E0B; }
        .ride-card {
            border: 1px solid #ddd;
            border-left-width: 5px;
            border-left-color: #FBBF24; /* Amber-400 */
            background: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 1rem;
        }
        /* --- FIN DE FORMATO CONGELADO --- */
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-start justify-center">

    <div id="appContainer" class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 md:p-8 mt-4">

        <!-- Header: Formato Taxi del Valle (Congelado) -->
        <header class="bg-amber-500 text-white p-4 rounded-lg mb-6 shadow-md">
            <h1 class="text-3xl font-extrabold text-center text-gray-900">
                Taxi del Valle (Chofer)
            </h1>
            <p id="connectionStatus" class="text-center text-sm mt-1 text-gray-700">
                Buscando viajes...
            </p>
        </header>
        
        <h2 class="text-xl font-bold text-gray-900 mb-4 text-center">
            Viajes Pendientes
        </h2>

        <!-- Lista de Viajes Pendientes -->
        <div id="rideList" class="space-y-4">
            <!-- Los viajes pendientes se cargarán aquí -->
            <p id="noRidesMessage" class="text-center text-gray-500 py-8">
                No hay viajes pendientes por el momento. Esperando...
            </p>
        </div>

    </div>

    <!-- Modal de Mensajes (Congelado) -->
    <div id="messageBox" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="messageContent" class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center"></div>
    </div>
    
    <script type="module">
        // === ¡CONFIGURACIÓN DE APPSHEET COMPLETA! ===
        const APPSHEET_APP_ID = "24f8735e-447a-48cd-a503-7deb1149c3ba"; 
        const APPSHEET_ACCESS_KEY = "V2-R5pzi-2brtL-KObNl-nPiDe-GIxT9-4PiuP-l72L4-KrkOd"; 
        const APPSHEET_TABLE_NAME = "Pedidos"; 
        // ---------------------------------------------------

        let APPSHEET_API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_APP_ID}/tables/${APPSHEET_TABLE_NAME}/Action`;
        
        // === REFERENCIAS DEL DOM ===
        const rideListContainer = document.getElementById('rideList');
        const connectionStatus = document.getElementById('connectionStatus');
        const noRidesMessage = document.getElementById('noRidesMessage');
        let currentPollingInterval;

        // --- Utilidades (Congelado) ---
        const showMessage = (title, text, isError = false) => {
            document.getElementById('messageContent').innerHTML = `
                <h2 class="text-xl font-bold mt-3 ${isError ? 'text-red-600' : 'text-gray-900'}">${title}</h2>
                <p class="text-gray-600 mt-2">${text}</p>
                <button onclick="window.closeMessage()" class="mt-4 py-2 px-4 bg-amber-500 text-gray-900 font-semibold rounded-lg hover:bg-amber-600 transition">Aceptar</button>
            `;
            document.getElementById('messageBox').classList.remove('hidden');
            document.getElementById('messageBox').classList.add('flex');
        };
        window.closeMessage = () => { document.getElementById('messageBox').classList.add('hidden'); document.getElementById('messageBox').classList.remove('flex'); };
        

        // --- Lógica Principal del Chofer ---

        /**
         * Busca en AppSheet filas que coincidan con [ESTADO] = "pending"
         */
        const fetchPendingRides = async () => {
            if (APPSHEET_APP_ID === "TU_APP_ID_AQUI" || !APPSHEET_APP_ID) {
                connectionStatus.textContent = "Error: Falta App ID en la configuración.";
                if (currentPollingInterval) clearInterval(currentPollingInterval);
                return;
            }

            APPSHEET_API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_APP_ID}/tables/${APPSHEET_TABLE_NAME}/Action`;
            
            console.log("Buscando viajes pendientes...");
            connectionStatus.textContent = "Buscando viajes...";

            try {
                const response = await fetch(APPSHEET_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': APPSHEET_ACCESS_KEY
                    },
                    body: JSON.stringify({
                        "Action": "Find", // Acción para buscar filas
                        "Properties": {
                            "Locale": "es-ES",
                            // CRÍTICO: Usando [ESTADO] según las columnas proporcionadas.
                            "Selector": `FILTER(Pedidos, [ESTADO] = "pending")` 
                        },
                        "Rows": [] 
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error de AppSheet (${response.status}): ${errorText}`);
                }

                const pendingRides = await response.json();
                
                // --- LOG DE DEPURACIÓN (Verifica si AppSheet está enviando datos) ---
                console.log(`[DEBUG] Viajes recibidos desde AppSheet: ${pendingRides.length} filas.`);
                if (pendingRides.length > 0) {
                    console.log("[DEBUG] Primer viaje recibido:", pendingRides[0]);
                }
                // -----------------------------------------------------------------

                connectionStatus.textContent = "Conectado. Esperando viajes.";
                displayRides(pendingRides);

            } catch (error) {
                console.error("Error al buscar viajes:", error);
                
                if (error.message.includes("403")) {
                    connectionStatus.textContent = "Error de Configuración (403). Habilita el API REST en AppSheet.";
                } else {
                    connectionStatus.textContent = "Error de conexión. Reintentando en 10s.";
                }
            }
        };

        /**
         * Muestra los viajes encontrados en la UI
         */
        const displayRides = (rides) => {
            rideListContainer.innerHTML = ''; 
            
            if (!rides || rides.length === 0) {
                noRidesMessage.classList.remove('hidden');
                rideListContainer.appendChild(noRidesMessage); 
                return;
            }

            noRidesMessage.classList.add('hidden');
            
            rides.forEach(ride => {
                const card = document.createElement('div');
                card.className = 'ride-card';
                
                // Usando los nombres de columna proporcionados por el usuario
                const origen = ride.ORIGEN_DIRECCION || (ride.ORIGEN_UBICACION ? 'Ubicación GPS' : 'Dirección no especificada');
                const destino = ride.DESTINO_DIRECCION || (ride.DESTINO_UBICACION ? 'Ubicación GPS' : 'Dirección no especificada');
                
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <!-- Quitamos precio y tiempo estimados ya que no están en las columnas proporcionadas -->
                        <h3 class="text-xl font-bold text-gray-900">Nuevo Viaje</h3>
                    </div>
                    <p class="text-sm text-gray-700 mb-1">
                        <strong class="text-gray-900">Desde:</strong> ${origen}
                    </p>
                    <p class="text-sm text-gray-700 mb-3">
                        <strong class="text-gray-900">Hasta:</strong> ${destino}
                    </p>
                    <p class="text-sm text-gray-600 italic mb-4">
                        <strong class="text-gray-900">Comentarios:</strong> ${ride.COMENTARIOS_CLIENTE || 'Sin comentarios adicionales.'}
                    </p>
                    
                    <button 
                        data-ride-id="${ride.ID_PEDIDO}" 
                        class="w-full py-2 px-4 rounded-lg text-gray-900 font-semibold shadow-md btn-active"
                    >
                        Aceptar Viaje
                    </button>
                `;
                
                // Adjuntar el listener de evento al botón creado
                card.querySelector('button').addEventListener('click', (e) => {
                    const rideId = e.target.dataset.rideId;
                    acceptRide(rideId);
                });
                
                rideListContainer.appendChild(card);
            });
        };

        /**
         * Acepta un viaje (Edita la fila en AppSheet)
         */
        const acceptRide = async (rideId) => {
            console.log(`Aceptando viaje: ${rideId}`);
            // Usamos un ID de chofer simulado, que podrías reemplazar con un ID de usuario real de Firebase si lo usaras
            const driverId = `CHOFER_${Math.random().toString(36).substring(2, 6)}`; 
            
            try {
                 const response = await fetch(APPSHEET_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': APPSHEET_ACCESS_KEY
                    },
                    body: JSON.stringify({
                        "Action": "Edit", // Acción para editar filas
                        "Properties": { "Locale": "es-ES" },
                        "Rows": [
                            {
                                // Columna clave para identificar la fila a editar
                                "ID_PEDIDO": rideId, 
                                // Columna de estado y chofer asignado (¡COINCIDENCIA DE MAYÚSCULAS CRÍTICA!)
                                "ESTADO": "accepted", 
                                "CHOFER_ASIGNADO_REF": driverId 
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error al aceptar (${response.status}): ${errorText}`);
                }
                
                showMessage("¡Viaje Aceptado!", `Has aceptado el viaje con ID: ${rideId}. ¡Buen viaje!`);
                fetchPendingRides(); // Recargar la lista para que el viaje desaparezca
                
            } catch (error) {
                 console.error("Error al aceptar el viaje:", error);
                 showMessage("Error", `No se pudo aceptar el viaje: ${error.message}`, true);
            }
        };


        // --- Lógica de Carga ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchPendingRides(); // Buscar la primera vez
            
            // Polling: Buscar nuevos viajes cada 10 segundos
            currentPollingInterval = setInterval(fetchPendingRides, 10000); 
        });
        
    </script>
</body>
</html>
