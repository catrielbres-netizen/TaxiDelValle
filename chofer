<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista del Chofer: Taxi del Valle</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Carga de React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Imports: Agregamos query y where para filtros -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, serverTimestamp, setLogLevel, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Exponer módulos de Firebase al scope global para que el código Babel los use
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, onSnapshot, collection, setDoc, serverTimestamp, setLogLevel,
            query, where // Módulos para consultas avanzadas
        };

        // setLogLevel('debug'); // Activación de logs para diagnóstico
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Animación de carga */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #10b981; /* Verde es el color del chofer */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // =================================================================
        // CONFIGURACIÓN INICIAL Y AUTENTICACIÓN
        // =================================================================
        
        const { useState, useEffect } = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
                getFirestore, doc, onSnapshot, collection, setDoc, serverTimestamp, 
                query, where } = window.firebase;

        // Variables Globales del Entorno Canvas
        const safeParseConfig = () => {
            try {
                return typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
                return {};
            }
        };

        const firebaseConfig = safeParseConfig();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-taxi-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // =================================================================
        // COMPONENTES DE VISTA
        // =================================================================

        // -----------------------------------------------------------------
        // Utilidades
        // -----------------------------------------------------------------
        const LucideIcon = ({ name, className }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);
            
            return (
                <i className={className}>
                    <svg data-lucide={name} width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </i>
            );
        };
        
        const formatCurrency = (amount) => {
            return `$${(amount || 0).toLocaleString('es-AR', { minimumFractionDigits: 0 })}`;
        };
        
        // -----------------------------------------------------------------
        // Componente: Lista de Pedidos Pendientes
        // -----------------------------------------------------------------
        const AvailableTripsList = ({ trips, onTakeTrip }) => {
            if (trips.length === 0) {
                return (
                    <div className="text-center p-6 bg-white rounded-xl shadow-inner mt-4">
                        <LucideIcon name="check-circle" className="w-8 h-8 mx-auto text-teal-500 mb-2" />
                        <p className="text-gray-600 font-semibold">No hay pedidos disponibles en este momento.</p>
                        <p className="text-sm text-gray-400">¡A esperar!</p>
                    </div>
                );
            }

            return (
                <div className="space-y-4">
                    {trips.map(trip => (
                        <div key={trip.ID_PEDIDO} className="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
                            <div className="flex justify-between items-start">
                                <h3 className="font-bold text-lg text-gray-800 flex items-center">
                                    <LucideIcon name="map-pin" className="w-5 h-5 mr-2 text-teal-600" />
                                    Nuevo Pedido
                                </h3>
                                <span className="text-sm font-bold text-green-600 bg-green-100 px-3 py-1 rounded-full">
                                    {formatCurrency(trip.FARE_SIMULATED)}
                                </span>
                            </div>
                            
                            <p className="text-sm text-gray-500 mt-2">
                                <span className="font-semibold text-gray-700">Origen:</span> {trip.ORIGEN_DIRECCION}
                            </p>
                            <p className="text-sm text-gray-500">
                                <span className="font-semibold text-gray-700">Destino:</span> {trip.DESTINO_DIRECCION}
                            </p>

                            <p className="text-xs text-gray-400 mt-2">
                                Cliente: {trip.CLIENTE_REF_DNI} | Tel: {trip.phone}
                            </p>

                            <button
                                onClick={() => onTakeTrip(trip.ID_PEDIDO)}
                                className="mt-4 w-full p-3 bg-teal-600 text-white rounded-lg font-semibold hover:bg-teal-700 transition duration-300 transform hover:scale-[1.01] shadow-md"
                            >
                                <LucideIcon name="car" className="w-5 h-5 mr-2 inline-block" />
                                Tomar Pedido
                            </button>
                        </div>
                    ))}
                </div>
            );
        };
        
        // -----------------------------------------------------------------
        // Componente: Viaje Activo
        // -----------------------------------------------------------------
        const ActiveTripMonitor = ({ trip, onMarkArrival, onFinishTrip, isProcessing }) => {
            const getStatusDisplay = (status) => {
                let text, color;
                switch (status) {
                    case 'ASIGNADO':
                        text = "En Camino al Origen";
                        color = "blue";
                        break;
                    case 'LLEGADA AL ORIGEN':
                        text = "Cliente Esperando";
                        color = "orange";
                        break;
                    default:
                        text = "Desconocido";
                        color = "gray";
                }
                return { text, colorClass: `bg-${color}-100 text-${color}-600` };
            };

            const statusInfo = getStatusDisplay(trip.ESTADO);

            return (
                <div className="space-y-4 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-teal-500">
                    <h2 className="text-2xl font-bold text-gray-800">Mi Viaje Activo</h2>
                    
                    <div className="p-3 rounded-lg font-semibold text-center border-2 shadow-sm"
                         style={{ backgroundColor: statusInfo.colorClass.split('-')[0] === 'blue' ? '#dbeafe' : '#ffeccb' }}>
                        <span className={`text-lg font-extrabold text-${statusInfo.color}-800`}>{statusInfo.text}</span>
                    </div>

                    <div className="space-y-3">
                        <TripDetail icon="circle-dot" title="Origen" address={trip.ORIGEN_DIRECCION} color="green" />
                        <TripDetail icon="flag" title="Destino" address={trip.DESTINO_DIRECCION} color="red" />
                    </div>

                    <p className="text-sm text-gray-500 pt-2">Cliente: {trip.CLIENTE_REF_DNI} | Pedido ID: {trip.ID_PEDIDO.substring(0, 8)}...</p>

                    {/* Botones de Acción según el estado */}
                    {trip.ESTADO === 'ASIGNADO' && (
                        <button
                            onClick={() => onMarkArrival(trip.ID_PEDIDO)}
                            disabled={isProcessing}
                            className={`w-full p-4 bg-blue-600 text-white rounded-xl font-bold transition duration-300 shadow-lg ${isProcessing ? 'bg-gray-400' : 'hover:bg-blue-700'}`}
                        >
                            <LucideIcon name="bell" className="w-5 h-5 mr-2 inline-block" />
                            {isProcessing ? 'Procesando...' : 'Marcar: ¡Llegué al Origen!'}
                        </button>
                    )}
                    
                    {trip.ESTADO === 'LLEGADA AL ORIGEN' && (
                        <button
                            onClick={() => onFinishTrip(trip.ID_PEDIDO)}
                            disabled={isProcessing}
                            className={`w-full p-4 bg-teal-600 text-white rounded-xl font-bold transition duration-300 shadow-lg ${isProcessing ? 'bg-gray-400' : 'hover:bg-teal-700'}`}
                        >
                            <LucideIcon name="dollar-sign" className="w-5 h-5 mr-2 inline-block" />
                            {isProcessing ? 'Finalizando...' : 'Finalizar Viaje'}
                        </button>
                    )}
                </div>
            );
        };
        
        // -----------------------------------------------------------------
        // Componente Auxiliar para Detalles de Viaje
        // -----------------------------------------------------------------
        const TripDetail = ({ icon, title, address, color }) => (
            <div className="flex items-start p-3 bg-gray-50 rounded-lg border">
                <LucideIcon name={icon} className={`w-5 h-5 mt-1 mr-3 text-${color}-500 flex-shrink-0`} />
                <div>
                    <p className="text-xs font-medium text-gray-400">{title}</p>
                    <p className="font-semibold text-gray-700">{address}</p>
                </div>
            </div>
        );


        // =================================================================
        // COMPONENTE PRINCIPAL (App)
        // =================================================================
        const App = () => {
            const [authState, setAuthState] = useState({ 
                isLoading: true, 
                db: null, 
                auth: null, 
                userId: null 
            });
            const [availableTrips, setAvailableTrips] = useState([]);
            const [currentTrip, setCurrentTrip] = useState(null); // El viaje que el chofer ha tomado
            const [isProcessing, setIsProcessing] = useState(false);
            
            const TRIP_COLLECTION_PATH = `artifacts/${appId}/public/data/tripRequests`;

            // 1. Inicialización de Firebase y Autenticación
            useEffect(() => {
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    setAuthState(prev => ({ ...prev, isLoading: false }));
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase auth error:", error);
                            }
                        }
                        
                        if (auth.currentUser) {
                             const userId = auth.currentUser.uid;
                             // En el contexto del Chofer, es MUY importante mostrar el ID
                             console.log("Chofer UID:", userId); 
                             setAuthState({ isLoading: false, db, auth, userId });
                        }
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Failed to initialize Firebase:", e);
                    setAuthState(prev => ({ ...prev, isLoading: false }));
                }
            }, []);
            
            // 2. Monitoreo de Viaje ACTIVO (SL_MI_VIAJE_ACTIVO)
            useEffect(() => {
                if (!authState.db || !authState.userId) return;

                const db = authState.db;
                const userId = authState.userId;
                
                // Consulta: Chofer asignado = mi userId, y el estado NO ES FINALIZADO o CANCELLED
                const activeQuery = query(
                    collection(db, TRIP_COLLECTION_PATH),
                    where("CHOFER_ASIGNADO_REF", "==", userId),
                    where("ESTADO", "in", ["ASIGNADO", "LLEGADA AL ORIGEN"])
                );

                const unsubscribe = onSnapshot(activeQuery, (snapshot) => {
                    if (snapshot.docs.length > 0) {
                        const trip = { ID_PEDIDO: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                        setCurrentTrip(trip);
                        console.log("Viaje activo detectado:", trip.ESTADO);
                    } else {
                        setCurrentTrip(null); // No hay viaje activo
                    }
                }, (error) => {
                    console.error("Error monitoring active trip:", error);
                });

                return () => unsubscribe();
            }, [authState.db, authState.userId]); 

            // 3. Monitoreo de Pedidos PENDIENTES (SL_PEDIDOS_DISPONIBLES)
            useEffect(() => {
                if (!authState.db || currentTrip) return; // Solo buscar si no tengo un viaje activo

                const db = authState.db;
                
                // Consulta: Estado = PENDING
                const pendingQuery = query(
                    collection(db, TRIP_COLLECTION_PATH),
                    where("ESTADO", "==", "PENDING")
                    // No se usa orderBy ni limit para mantener la simplicidad y evitar errores de índice
                );

                const unsubscribe = onSnapshot(pendingQuery, (snapshot) => {
                    const trips = snapshot.docs.map(doc => ({
                        ID_PEDIDO: doc.id,
                        ...doc.data()
                    }));
                    setAvailableTrips(trips);
                }, (error) => {
                    console.error("Error monitoring pending trips:", error);
                });

                return () => unsubscribe();
            }, [authState.db, currentTrip]); 
            
            // Lógica de Acciones (similar a las de AppSheet)
            
            // 4. TOMAR_PEDIDO
            const handleTakeTrip = async (tripId) => {
                if (!authState.db || !authState.userId) return;
                setIsProcessing(true);
                
                try {
                    const tripRef = doc(authState.db, TRIP_COLLECTION_PATH, tripId);
                    
                    // Asegurarse de que nadie más lo haya tomado justo antes
                    // Esto es una simplificación; AppSheet manejaría mejor la concurrencia.
                    // Aquí, simplemente actualizamos.
                    await setDoc(tripRef, { 
                        ESTADO: 'ASIGNADO', 
                        CHOFER_ASIGNADO_REF: authState.userId 
                    }, { merge: true });
                    
                    // Forzamos el cambio de estado local para que se active el monitoreo de currentTrip
                    setCurrentTrip({ ID_PEDIDO: tripId, ESTADO: 'ASIGNADO' });

                } catch (error) {
                    console.error("Error taking trip:", error);
                    // Sustitución de alert
                    console.log("Error al tomar el viaje. Intente nuevamente."); 
                } finally {
                    setIsProcessing(false);
                }
            };
            
            // 5. MARCAR_LLEGADA
            const handleMarkArrival = async (tripId) => {
                if (!authState.db) return;
                setIsProcessing(true);
                
                try {
                    const tripRef = doc(authState.db, TRIP_COLLECTION_PATH, tripId);
                    await setDoc(tripRef, { ESTADO: 'LLEGADA AL ORIGEN' }, { merge: true });
                } catch (error) {
                    console.error("Error marking arrival:", error);
                } finally {
                    setIsProcessing(false);
                }
            };
            
            // 6. FINALIZAR_VIAJE
            const handleFinishTrip = async (tripId) => {
                if (!authState.db) return;
                setIsProcessing(true);
                
                try {
                    const tripRef = doc(authState.db, TRIP_COLLECTION_PATH, tripId);
                    
                    // En un flujo real, aquí AppSheet abriría un formulario para liquidación (COSTO_FINAL_PESOS, etc.)
                    // Aquí, simplemente marcamos el viaje como finalizado.
                    await setDoc(tripRef, { ESTADO: 'FINALIZADO' }, { merge: true });
                    
                    // El listener debería detectar esto y poner currentTrip a null
                    setCurrentTrip(prev => ({...prev, ESTADO: 'FINALIZADO'})); 
                    
                } catch (error) {
                    console.error("Error finishing trip:", error);
                } finally {
                    setIsProcessing(false);
                }
            };

            if (authState.isLoading) {
                return (
                    <div className="flex justify-center items-center h-screen">
                        <div className="spinner mr-3"></div>
                        <p className="text-lg text-gray-700">Conectando con la base de datos...</p>
                    </div>
                );
            }

            return (
                <div className="max-w-xl mx-auto p-4 bg-gray-100 min-h-screen">
                    <header className="text-center mb-6 pt-4">
                        <LucideIcon name="car" className="w-8 h-8 mx-auto text-teal-600 mb-2" />
                        <h1 className="text-3xl font-extrabold text-gray-900">Módulo Chofer</h1>
                        <p className="text-sm text-gray-500 flex items-center justify-center">
                            <LucideIcon name="user" className="w-4 h-4 mr-1"/> 
                            ID de Chofer (para AppSheet): <span className="font-mono text-xs text-teal-700 bg-teal-100 p-1 rounded ml-1">{authState.userId}</span>
                        </p>
                    </header>
                    
                    {currentTrip ? (
                        <ActiveTripMonitor 
                            trip={currentTrip} 
                            onMarkArrival={handleMarkArrival} 
                            onFinishTrip={handleFinishTrip} 
                            isProcessing={isProcessing}
                        />
                    ) : (
                        <>
                            <h2 className="text-2xl font-bold text-gray-800 border-b pb-2">Pedidos Disponibles</h2>
                            <AvailableTripsList 
                                trips={availableTrips} 
                                onTakeTrip={handleTakeTrip} 
                            />
                        </>
                    )}
                    
                    {(currentTrip && currentTrip.ESTADO === 'FINALIZADO') && (
                         <div className="p-4 mt-6 rounded-xl border-2 border-teal-300 bg-teal-50">
                            <p className="font-semibold text-center text-gray-700">
                                Viaje Finalizado. ¡Buen trabajo!
                            </p>
                            <button
                                onClick={() => setCurrentTrip(null)}
                                className="mt-3 w-full p-3 bg-teal-600 text-white rounded-xl font-semibold hover:bg-teal-700 transition duration-300"
                            >
                                <LucideIcon name="list-checks" className="w-5 h-5 mr-2 inline-block" />
                                Ver Nuevos Pedidos
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // Renderizado de la App
        const rootElement = document.getElementById('root');
        if (rootElement) {
            ReactDOM.createRoot(rootElement).render(<App />);
        }

    </script>
</body>
</html>
