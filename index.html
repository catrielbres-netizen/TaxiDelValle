<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido de Taxi del Valle</title>
    <!-- Incluye Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SDK de TomTom (SOLO CSS) -->
    <link rel="stylesheet" type="text/css" href="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.1/maps-sdk.css" />
    
    <style>
        /* No modificar este bloque de formato */
        body { font-family: 'Inter', sans-serif; }
        
        #map {
            height: 350px; 
            width: 100%;
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: crosshair;
        }
        
        .btn-disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-active {
            background-color: #FBBF24; /* Amber-400 */
            color: #1F2937;
            cursor: pointer;
            opacity: 1;
            transition: background-color 0.2s;
        }
        .btn-active:hover:not(:disabled) {
             background-color: #F59E0B; /* Amber-500 */
        }

        /* Estilos para los resultados de búsqueda */
        .search-results {
            position: absolute;
            width: 100%;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        .result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .result-item:hover {
            background-color: #f5f5f5;
        }
        .result-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-start justify-center">

    <div id="appContainer" class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 md:p-8 mt-4">

        <!-- Header: Formato Taxi del Valle (No modificar) -->
        <header class="bg-amber-500 text-white p-4 rounded-lg mb-6 shadow-md">
            <h1 class="text-3xl font-extrabold text-center text-gray-900">
                Taxi del Valle
            </h1>
            <p id="authStatus" class="text-center text-sm mt-1 text-gray-700">
                Conectando...
            </p>
            <p id="userIdDisplay" class="text-xs text-gray-700 mt-1 truncate text-center">
                ID Cliente: ...
            </p>
        </header>
        
        <!-- Contenedor del Mapa -->
        <div id="map" class="mb-4"></div>

        <h2 class="text-xl font-bold text-gray-900 mb-4 text-center">
            Selecciona tu Destino
        </h2>

        <!-- Formulario principal con ID para JS -->
        <form id="rideForm" class="space-y-4">
            
            <!-- Origen (Geolocalización) -->
            <fieldset class="border p-4 rounded-lg">
                <legend class="text-sm font-semibold text-gray-700 px-2">1. Origen (Tú)</legend>
                
                <div>
                    <label for="origen" class="block text-sm font-medium text-gray-700 mb-1">
                        Tu Ubicación Actual (Auto-detectada)
                    </label>
                    <input 
                        type="text" 
                        id="origen" 
                        name="origen" 
                        disabled 
                        placeholder="Obteniendo ubicación..."
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100"
                    >
                    <input type="hidden" id="origen_lat" name="origen_lat">
                    <input type="hidden" id="origen_lon" name="origen_lon">
                </div>

                <!-- Campo de Descripción Adicional -->
                <div class="mt-4">
                    <label for="origen_description" class="block text-sm font-medium text-gray-700 mb-1">
                        Descripción de Ubicación (Ej: Frente al árbol)
                    </label>
                    <input 
                        type="text" 
                        id="origen_description" 
                        name="origen_description" 
                        placeholder="Detalles para que el chofer te ubique fácilmente."
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500"
                    >
                </div>
            </fieldset>

            <!-- Destino (Selección en Mapa O Búsqueda) -->
            <fieldset class="border p-4 rounded-lg">
                <legend class="text-sm font-semibold text-gray-700 px-2">2. Destino</legend>

                <!-- Búsqueda de Destino -->
                <div class="relative">
                    <label for="destino_search" class="block text-sm font-medium text-gray-700 mb-1">
                        Buscar Dirección de Destino <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="destino_search" 
                        placeholder="Escribe una calle, altura o lugar..."
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500"
                    >
                    <!-- Contenedor para los resultados de búsqueda -->
                    <div id="destino_results" class="search-results hidden"></div>
                </div>

                <div class="mt-4">
                    <label for="destino" class="block text-sm font-medium text-gray-700 mb-1">
                        Destino Seleccionado (del Mapa o Búsqueda)
                    </label>
                    <input 
                        type="text" 
                        id="destino" 
                        name="destino" 
                        required 
                        disabled 
                        placeholder="Haz clic en el mapa o busca una dirección..."
                        class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100"
                    >
                    <input type="hidden" id="destino_lat" name="destino_lat">
                    <input type="hidden" id="destino_lon" name="destino_lon">
                </div>
            </fieldset>
            
            <!-- Estimación de Viaje -->
            <div id="estimationBox" class="bg-blue-100 p-4 rounded-lg shadow-inner hidden">
                <h3 class="font-bold text-lg text-blue-800 mb-2">Estimación del Viaje</h3>
                <p class="text-sm text-gray-700">
                    <strong class="text-blue-600">Tiempo Estimado:</strong> <span id="estimatedTime" class="font-medium">--</span>
                </p>
                <p class="text-sm text-gray-700">
                    <strong class="text-blue-600">Precio Estimado:</strong> <span id="estimatedPrice" class="font-medium text-xl">--</span>
                </p>
            </div>


            <!-- Campos Opcionales -->
            <div class="flex space-x-4">
                <div class="w-1/2">
                    <label for="pasajeros" class="block text-sm font-medium text-gray-700 mb-1">Pasajeros</label>
                    <input type="number" id="pasajeros" name="pasajeros" value="1" min="1" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div class="w-1/2">
                    <label for="pago" class="block text-sm font-medium text-gray-700 mb-1">Método de Pago</label>
                    <select id="pago" name="pago" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <option value="cash">Efectivo</option>
                        <option value="card">Tarjeta (Simulado)</option>
                    </select>
                </div>
            </div>

            <div>
                <label for="notas" class="block text-sm font-medium text-gray-700 mb-1">
                    Notas Adicionales
                </label>
                <textarea 
                    id="notas" 
                    name="notas" 
                    rows="2"
                    placeholder="Ej: Necesito espacio para maletas."
                    class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500 resize-none"
                ></textarea>
            </div>

            <!-- Botón de Envío: Formato Taxi del Valle (No modificar) -->
            <button 
                type="submit" 
                id="submitButton" 
                disabled 
                class="w-full mt-6 py-3 px-4 rounded-lg text-gray-900 font-semibold shadow-xl transition duration-200 ease-in-out btn-disabled"
            >
                <span id="buttonText">Selecciona Destino y Origen</span>
            </button>
        </form>
    </div>

    <!-- Contenedor para mensajes (Modal) -->
    <div id="messageBox" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="messageContent" class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
            <!-- El contenido se inyecta con JS -->
        </div>
    </div>
    
    <!-- SDK de TomTom (JavaScript) -->
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/6.x/6.25.1/maps-sdk.min.js"></script>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, collection, query, where, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuración de Firestore
        setLogLevel('Debug');

        // === CONFIGURACIÓN GLOBAL ===
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Clave API de TomTom
        const TOMTOM_API_KEY = "qfiNAZGwcmXAFKdmxn9eggudv5Hw87tT";
        
        // Estado Global
        let firebaseApp, db, auth;
        let currentUserId = null;
        let map = null;
        let originMarker = null;
        let destinationMarker = null;

        let originCoords = null; // {lat, lon} del cliente
        let destinationCoords = null; // {lat, lon} del destino seleccionado
        
        // === REFERENCIAS DEL DOM ===
        const authStatus = document.getElementById('authStatus');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const form = document.getElementById('rideForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const origenInput = document.getElementById('origen');
        const origenLatInput = document.getElementById('origen_lat');
        const origenLonInput = document.getElementById('origen_lon');
        
        // Referencias de Destino (Búsqueda y Resultado)
        const destinoSearchInput = document.getElementById('destino_search');
        const destinoResultsContainer = document.getElementById('destino_results');
        const destinoInput = document.getElementById('destino');
        const destinoLatInput = document.getElementById('destino_lat');
        const destinoLonInput = document.getElementById('destino_lon');

        const estimationBox = document.getElementById('estimationBox');
        const estimatedTime = document.getElementById('estimatedTime');
        const estimatedPrice = document.getElementById('estimatedPrice');
        
        // --- Utilidades ---
        const showMessage = (title, text, icon) => {
            document.getElementById('messageContent').innerHTML = `
                ${icon || ''}
                <h2 class="text-xl font-bold mt-3 text-gray-900">${title}</h2>
                <p class="text-gray-600 mt-2">${text}</p>
                <button onclick="window.closeMessage()" class="mt-4 py-2 px-4 bg-amber-500 text-gray-900 font-semibold rounded-lg hover:bg-amber-600 transition">Aceptar</button>
            `;
            document.getElementById('messageBox').classList.remove('hidden');
            document.getElementById('messageBox').classList.add('flex');
        };

        window.closeMessage = () => {
            document.getElementById('messageBox').classList.add('hidden');
            document.getElementById('messageBox').classList.remove('flex');
        };

        // Función Debounce para no llamar al API en cada tecla
        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        
        // --- 1. Inicialización de Firebase y Autenticación ---

        const initializeFirebase = async () => {
            if (!firebaseConfig) {
                authStatus.textContent = 'Error: Configuración de Firebase no encontrada.';
                console.error("Configuración de Firebase no encontrada.");
                return;
            }
            
            try {
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error de inicialización de Firebase:", error);
                authStatus.textContent = `Error: Falló la inicialización.`;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    authStatus.textContent = 'Conectado. Listo para viajar.';
                    userIdDisplay.textContent = `ID Cliente: ${currentUserId}`;
                } else {
                    authStatus.textContent = 'Desconectado.';
                    currentUserId = null;
                }
            });
        };
        
        // --- 2. Geolocalización y Mapa (TomTom) ---

        const getClientLocation = () => {
            origenInput.value = "Obteniendo ubicación...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        originCoords = { lat, lon };
                        
                        origenLatInput.value = lat;
                        origenLonInput.value = lon;

                        if (map) {
                            const coords = [lon, lat]; // TomTom [lon, lat]
                            map.setCenter(coords);
                            map.setZoom(14);

                            if (originMarker) originMarker.remove();
                            originMarker = new tt.Marker({ color: '#DC2626' }) // Rojo para Origen
                                .setLngLat(coords)
                                .addTo(map);
                            
                            reverseGeocode(lat, lon, (address) => {
                                origenInput.value = address || "Ubicación detectada (coordenadas)";
                            });
                        }
                        checkButtonState();
                    },
                    (error) => {
                        console.warn("Error de Geolocalización:", error.message);
                        origenInput.value = "Ubicación denegada o fallida.";
                        const icon = `
                            <svg class="mx-auto h-12 w-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>`;
                        showMessage("Permiso Necesario", "Permite la geolocalización para establecer tu origen.", icon);
                        checkButtonState();
                    }
                );
            } else {
                origenInput.value = "Geolocalización no soportada.";
                checkButtonState();
            }
        };

        const initializeMap = () => {
            const defaultLocation = [-58.3816, -34.6037]; // Buenos Aires [lon, lat]
            
            try {
                map = tt.map({
                    key: TOMTOM_API_KEY,
                    container: 'map',
                    center: defaultLocation,
                    zoom: 12
                });
                
                // Listener para seleccionar el destino en el mapa
                map.on('click', (e) => {
                    const lat = e.lngLat.lat;
                    const lon = e.lngLat.lng;
                    
                    setDestination({ lat, lon });
                });

                // Obtener ubicación del cliente al cargar el mapa
                map.on('load', getClientLocation);

            } catch (error) {
                console.error("Error inicializando TomTom:", error);
                const icon = `
                    <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                showMessage("Error de Mapa", "No se pudo inicializar el mapa. Intenta recargar.", icon);
            }
        };
        
        const setDestination = (coords, address = null) => {
            destinationCoords = coords;
            
            destinoLatInput.value = coords.lat;
            destinoLonInput.value = coords.lon;
            destinoSearchInput.value = ''; // Limpiar input de búsqueda
            destinoResultsContainer.classList.add('hidden'); // Ocultar resultados

            // Agregar marcador de destino (Azul)
            if (destinationMarker) destinationMarker.remove();
            destinationMarker = new tt.Marker({ color: '#1E40AF' }) // Azul para Destino
                .setLngLat([coords.lon, coords.lat])
                .addTo(map);
            
            if (originCoords) {
                const bounds = new tt.LngLatBounds();
                bounds.extend([originCoords.lon, originCoords.lat]);
                bounds.extend([coords.lon, coords.lat]);
                map.fitBounds(bounds, { padding: 80 });
            }

            if (address) {
                destinoInput.value = address;
            } else {
                destinoInput.value = "Buscando dirección...";
                reverseGeocode(coords.lat, coords.lon, (foundAddress) => {
                    destinoInput.value = foundAddress || `Destino seleccionado en (${coords.lat.toFixed(4)}, ${coords.lon.toFixed(4)})`;
                });
            }
            
            calculateRouteAndEstimate();
        };

        const reverseGeocode = async (lat, lon, callback) => {
            try {
                // LLAMADA REAL AL API DE TOMTOM
                const response = await fetch(`https://api.tomtom.com/search/2/reverseGeocode/${lat},${lon}.json?key=${TOMTOM_API_KEY}&radius=100`);
                if (!response.ok) throw new Error('Respuesta de red no fue ok.');
                
                const data = await response.json();
                
                if (data.addresses && data.addresses.length > 0) {
                    const bestMatch = data.addresses[0].address.freeformAddress;
                    callback(bestMatch);
                } else {
                    callback(`Coords: ${lat.toFixed(4)}, ${lon.toFixed(4)}`);
                }
            } catch (error) {
                console.warn("Error en Reverse Geocode, usando simulación:", error);
                // Fallback a simulación si falla el API
                const simulatedAddress = `Calle Falsa #123 (Simulado)`;
                callback(simulatedAddress);
            }
        };
        
        
        // --- 3. BÚSQUEDA DE DESTINO (NUEVO) ---
        
        const handleDestinationSearch = async () => {
            const query = destinoSearchInput.value;
            
            if (query.length < 3) {
                destinoResultsContainer.classList.add('hidden');
                return;
            }
            
            // Bias de búsqueda cerca del origen del cliente
            const biasLocation = originCoords ? `${originCoords.lon},${originCoords.lat}` : null;

            try {
                // LLAMADA REAL AL API DE BÚSQUEDA DE TOMTOM
                let url = `https://api.tomtom.com/search/2/search/${encodeURIComponent(query)}.json?key=${TOMTOM_API_KEY}&language=es-ES&limit=5`;
                if (biasLocation) {
                    url += `&lon=${originCoords.lon}&lat=${originCoords.lat}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Respuesta de red no fue ok.');
                
                const data = await response.json();
                
                if (data.results) {
                    displaySearchResults(data.results);
                } else {
                    destinoResultsContainer.classList.add('hidden');
                }

            } catch (error) {
                 console.warn("Error en API de Búsqueda, usando simulación:", error);
                 // Fallback a simulación si falla el API
                const simulatedResults = [
                    { address: { freeformAddress: 'Av. Corrientes 1000, CABA (Simulado)' }, position: { lat: -34.6037, lon: -58.3816 } },
                    { address: { freeformAddress: 'Calle Falsa 123, Springfield (Simulado)' }, position: { lat: -34.5986, lon: -58.3822 } },
                ];
                displaySearchResults(simulatedResults);
            }
        };

        const displaySearchResults = (results) => {
            destinoResultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                destinoResultsContainer.classList.add('hidden');
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.textContent = result.address.freeformAddress;
                
                // Usamos atributos de datos para evitar problemas con comillas en 'onclick'
                item.dataset.lat = result.position.lat;
                item.dataset.lon = result.position.lon;
                item.dataset.address = result.address.freeformAddress;

                item.addEventListener('click', () => {
                    setDestination(
                        { lat: item.dataset.lat, lon: item.dataset.lon }, 
                        item.dataset.address
                    );
                });
                
                destinoResultsContainer.appendChild(item);
            });
            
            destinoResultsContainer.classList.remove('hidden');
        };

        // Listener para la búsqueda (debounced)
        destinoSearchInput.addEventListener('input', debounce(handleDestinationSearch, 350));

        // Ocultar resultados si se hace clic fuera
        document.addEventListener('click', (e) => {
            if (e.target.id !== 'destino_search') {
                destinoResultsContainer.classList.add('hidden');
            }
        });

        // --- 4. Estimación de Viaje ---
        
        const calculateRouteAndEstimate = async () => {
            if (!originCoords || !destinationCoords) {
                estimationBox.classList.add('hidden');
                checkButtonState();
                return;
            }
            
            estimationBox.classList.remove('hidden');
            estimatedTime.textContent = 'Calculando...';
            estimatedPrice.textContent = 'Calculando...';
            
            try {
                // LLAMADA REAL AL API DE RUTAS DE TOMTOM
                const locations = `${originCoords.lon},${originCoords.lat}:${destinationCoords.lon},${destinationCoords.lat}`;
                const url = `https://api.tomtom.com/routing/1/calculateRoute/${locations}/json?key=${TOMTOM_API_KEY}&computeBestOrder=false&travelMode=taxi`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Respuesta de red no fue ok.');
                
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0].summary;
                    const distanceMeters = route.lengthInMeters;
                    const timeSeconds = route.travelTimeInSeconds;
                    
                    // Cálculo del precio (Fijo: $5.00 base + $1.50 por kilómetro)
                    const distanceKm = distanceMeters / 1000;
                    const basePrice = 5.00; // Tarifa base (simulada)
                    const ratePerKm = 1.50; // Tarifa por km (simulada)
                    const finalPrice = (basePrice + (distanceKm * ratePerKm)).toFixed(2);
                    
                    // Formato del tiempo
                    const timeMinutes = Math.ceil(timeSeconds / 60);
                    const timeString = `${timeMinutes} min`;
                    
                    estimatedTime.textContent = timeString;
                    estimatedPrice.textContent = `$${finalPrice}`;

                } else {
                    throw new Error("No se encontraron rutas.");
                }

            } catch (error) {
                console.warn("Error en API de Rutas, usando simulación:", error);
                // Fallback a simulación
                const finalPrice = (Math.random() * 10 + 5).toFixed(2); // Precio aleatorio entre 5 y 15
                const timeString = `${Math.floor(Math.random() * 15 + 5)} min`; // Tiempo aleatorio
                
                estimatedTime.textContent = timeString;
                estimatedPrice.textContent = `$${finalPrice}`;
            }
            
            checkButtonState();
        };
        
        // --- 5. Lógica de Validación y Envío ---

        const checkButtonState = () => {
            const isOriginSet = !!originCoords;
            const isDestinationSet = !!destinationCoords;
            const isPriceCalculated = estimatedPrice.textContent !== '--' && !estimatedPrice.textContent.includes('Calculando');
            
            const isValid = isOriginSet && isDestinationSet && isPriceCalculated;
            
            submitButton.disabled = !isValid;
            
            if (isValid) {
                submitButton.classList.remove('btn-disabled');
                submitButton.classList.add('btn-active');
                buttonText.textContent = `Pedir Taxi - ${estimatedPrice.textContent}`;
            } else {
                submitButton.classList.remove('btn-active');
                submitButton.classList.add('btn-disabled');
                
                if (!isOriginSet) {
                    buttonText.textContent = 'Esperando ubicación de origen...';
                } else if (!isDestinationSet) {
                    buttonText.textContent = 'Selecciona o busca un destino';
                } else if (!isPriceCalculated) {
                    buttonText.textContent = 'Calculando precio...';
                } else {
                    buttonText.textContent = 'Completa la información';
                }
            }
        };

        document.getElementById('origen_description').addEventListener('input', checkButtonState);


        const handleSubmit = async (e) => {
            e.preventDefault(); 
            
            if (submitButton.disabled || !currentUserId) {
                 const icon = `
                    <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                showMessage("Error", "Asegúrate de tener un origen, un destino seleccionado y estar conectado.", icon);
                return;
            }
            
            submitButton.disabled = true;
            buttonText.textContent = 'Enviando Solicitud...';
            submitButton.classList.add('opacity-70', 'animate-pulse');

            try {
                // Usamos la colección pública para que la vean los choferes
                const requestsCollectionRef = collection(db, `artifacts/${appId}/public/data/ride_requests`);
                
                const requestData = {
                    userId: currentUserId,
                    origen_lat: originCoords.lat,
                    origen_lon: originCoords.lon,
                    destino_lat: destinationCoords.lat,
                    destino_lon: destinationCoords.lon,
                    origen_address: origenInput.value,
                    origen_description: document.getElementById('origen_description').value,
                    destino_address: destinoInput.value,
                    pasajeros: document.getElementById('pasajeros').value,
                    pago_method: document.getElementById('pago').value,
                    notas: document.getElementById('notas').value,
                    estimated_time: estimatedTime.textContent,
                    estimated_price: estimatedPrice.textContent,
                    status: 'pending', // Estado inicial para que el chofer lo vea
                    createdAt: new Date().toISOString(),
                };

                await addDoc(requestsCollectionRef, requestData);

                const successIcon = `
                    <svg class="mx-auto h-12 w-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                `;
                showMessage("¡Pedido Enviado!", `Tu taxi está siendo buscado. Precio: ${estimatedPrice.textContent}.`, successIcon);
                
                // Resetear UI
                if (destinationMarker) destinationMarker.remove();
                destinationCoords = null;
                destinoInput.value = "Esperando selección en el mapa...";
                destinoSearchInput.value = "";
                destinoLatInput.value = "";
                destinoLonInput.value = "";
                estimationBox.classList.add('hidden');
                
                submitButton.classList.remove('opacity-70', 'animate-pulse');
                
                checkButtonState(); 

            } catch (error) {
                console.error("Error al enviar el pedido:", error);
                submitButton.classList.remove('opacity-70', 'animate-pulse');
                checkButtonState();
                const errorIcon = `
                    <svg class="mx-auto h-12 w-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>`;
                showMessage("Error de Envío", "Hubo un error al guardar tu pedido. Intenta de nuevo.", errorIcon);
            }
        };

        form.addEventListener('submit', handleSubmit);
        
        // --- 6. Sistema de Carga del SDK (Solución al error de 'tt') ---

        const waitForTomTomSDK = () => {
            if (typeof tt !== 'undefined' && tt.map && tt.services) {
                console.log("SDK de TomTom cargado exitosamente.");
                initializeMap();
                initializeFirebase();
            } else {
                setTimeout(waitForTomTomSDK, 100);
            }
        };

        // Iniciar la aplicación
        waitForTomTomSDK();
    </script>
</body>
</html>
