<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vista del Cliente: Taxi del Valle</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Carga de React y Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, setDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Exponer módulos de Firebase al scope global para que el código Babel los use
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, onSnapshot, collection, addDoc, setDoc, serverTimestamp, setLogLevel
        };

        // Activación de logs para diagnóstico
        // setLogLevel('debug'); 
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Animación de carga */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // =================================================================
        // CONFIGURACIÓN INICIAL Y AUTENTICACIÓN
        // =================================================================
        
        const { useState, useEffect, useCallback } = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp, setDoc } = window.firebase;

        // Variables Globales del Entorno Canvas
        const safeParseConfig = () => {
            try {
                return typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
                return {};
            }
        };

        const firebaseConfig = safeParseConfig();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-taxi-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // API Key de TomTom (Actualizada con tu clave)
        const TOMTOM_API_KEY = "qfiNAZGwcmXAFKdmxn9eggudv5Hw87tT";
        const DEFAULT_FARE = 500; // Tarifa simulada en pesos

        // =================================================================
        // COMPONENTES DE VISTA
        // =================================================================

        // -----------------------------------------------------------------
        // Utilidades
        // -----------------------------------------------------------------
        const LucideIcon = ({ name, className }) => {
            useEffect(() => {
                lucide.createIcons();
            }, [name]);
            
            // Renderiza el SVG contenedor para el icono de Lucide
            return (
                <i className={className}>
                    <svg data-lucide={name} width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </i>
            );
        };

        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // -----------------------------------------------------------------
        // Formulario de Solicitud de Viaje
        // -----------------------------------------------------------------
        const RequestForm = ({ isSubmitting, onSubmit, tomTomSuggestions, onSearch, setFormData }) => {
            const [localData, setLocalData] = useState({
                name: '',
                phone: '',
                pickupSearch: '',
                dropoffSearch: '',
            });
            const [focusedField, setFocusedField] = useState(null);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setLocalData(prev => ({ ...prev, [name]: value }));
                
                // Si el campo es de búsqueda, notificar al componente padre
                if (name === 'pickupSearch' || name === 'dropoffSearch') {
                    onSearch(name, value);
                }
            };
            
            const handleSuggestionClick = (field, suggestion) => {
                const searchField = field === 'pickup' ? 'pickupSearch' : 'dropoffSearch';
                setLocalData(prev => ({ 
                    ...prev, 
                    [searchField]: suggestion.address,
                }));
                setFormData(prev => ({
                    ...prev,
                    [field + 'Location']: JSON.stringify(suggestion.position),
                    [field + 'Address']: suggestion.address,
                }));
                setFocusedField(null); // Ocultar sugerencias
            };

            const isFormValid = localData.name.trim() !== '' && 
                                localData.phone.trim() !== '' &&
                                localData.pickupSearch.trim() !== '' &&
                                localData.dropoffSearch.trim() !== '';

            return (
                <form onSubmit={e => onSubmit(e, localData)} className="space-y-4">
                    <h2 className="text-xl font-semibold text-gray-700">¿A dónde vamos?</h2>
                    
                    {/* Campos de Búsqueda */}
                    {['pickup', 'dropoff'].map(field => (
                        <div key={field} className="relative">
                            <label htmlFor={`${field}Search`} className="block text-sm font-medium text-gray-500">
                                {field === 'pickup' ? 'Origen (Recogida)' : 'Destino'}
                            </label>
                            <div className="mt-1">
                                <input
                                    type="text"
                                    name={`${field}Search`}
                                    id={`${field}Search`}
                                    value={localData[`${field}Search`]}
                                    onChange={handleInputChange}
                                    onFocus={() => setFocusedField(field)}
                                    onBlur={() => setTimeout(() => setFocusedField(null), 150)} // Pequeño delay para permitir clic
                                    placeholder={field === 'pickup' ? 'Ej: Av. Rivadavia 123' : 'Ej: Casa de Gobierno'}
                                    className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border"
                                />
                            </div>

                            {/* Sugerencias de TomTom */}
                            {focusedField === field && tomTomSuggestions.length > 0 && (
                                <ul className="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto">
                                    {tomTomSuggestions.map((s, index) => (
                                        <li 
                                            key={index}
                                            onMouseDown={() => handleSuggestionClick(field, s)} // Usar onMouseDown para capturar el click antes del onBlur
                                            className="p-3 text-sm text-gray-800 hover:bg-indigo-50 cursor-pointer flex items-start"
                                        >
                                            <LucideIcon name="map-pin" className="w-4 h-4 text-indigo-500 flex-shrink-0 mt-1 mr-2" />
                                            {s.address}
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    ))}
                    
                    {/* Campos de Contacto */}
                    <div className="flex space-x-4">
                        <div className="flex-1">
                            <label htmlFor="name" className="block text-sm font-medium text-gray-500">
                                Tu Nombre
                            </label>
                            <input
                                type="text"
                                name="name"
                                id="name"
                                value={localData.name}
                                onChange={handleInputChange}
                                className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border"
                                placeholder="Juan Pérez"
                            />
                        </div>
                        <div className="flex-1">
                            <label htmlFor="phone" className="block text-sm font-medium text-gray-500">
                                Teléfono
                            </label>
                            <input
                                type="tel"
                                name="phone"
                                id="phone"
                                value={localData.phone}
                                onChange={handleInputChange}
                                className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border"
                                placeholder="2804xxxxxx"
                            />
                        </div>
                    </div>

                    <button
                        type="submit"
                        disabled={isSubmitting || !isFormValid}
                        className={`w-full flex items-center justify-center p-4 rounded-xl font-bold text-white transition duration-300 shadow-lg ${
                            isSubmitting || !isFormValid 
                                ? 'bg-gray-400 cursor-not-allowed' 
                                : 'bg-indigo-600 hover:bg-indigo-700 transform hover:scale-[1.01]'
                        }`}
                    >
                        {isSubmitting ? (
                            <>
                                <div className="spinner mr-3"></div>
                                Solicitando...
                            </>
                        ) : (
                            <>
                                <LucideIcon name="send" className="w-5 h-5 mr-2" />
                                Solicitar Taxi Ahora (${DEFAULT_FARE})
                            </>
                        )}
                    </button>
                </form>
            );
        };

        // -----------------------------------------------------------------
        // Monitoreo de Estado del Viaje
        // -----------------------------------------------------------------
        const StatusMonitor = ({ tripData, onCancel }) => {
            const getStatusDisplay = (status) => {
                let text, icon, color;
                switch (status) {
                    case 'PENDING':
                        text = "Buscando un Chofer disponible...";
                        icon = "search";
                        color = "yellow";
                        break;
                    case 'ASIGNADO':
                        text = `Chofer ${tripData.CHOFER_ASIGNADO_REF} en camino.`;
                        icon = "car";
                        color = "green";
                        break;
                    case 'LLEGADA AL ORIGEN':
                        text = "¡El Chofer ha llegado a su ubicación!";
                        icon = "bell";
                        color = "blue";
                        break;
                    case 'FINALIZADO':
                        text = "Viaje Finalizado. ¡Gracias por viajar con nosotros!";
                        icon = "check-circle";
                        color = "indigo";
                        break;
                    case 'CANCELLED':
                        text = "Viaje cancelado.";
                        icon = "x-circle";
                        color = "red";
                        break;
                    default:
                        text = "Estado desconocido...";
                        icon = "help-circle";
                        color = "gray";
                }

                return { text, icon, colorClass: `text-${color}-600 bg-${color}-50 border-${color}-300` };
            };

            const statusInfo = getStatusDisplay(tripData.ESTADO);
            const isFinished = tripData.ESTADO === 'FINALIZADO' || tripData.ESTADO === 'CANCELLED';

            return (
                <div className="space-y-4">
                    <h2 className="text-xl font-bold text-gray-800 border-b pb-2">Estado de tu Viaje</h2>
                    
                    <div className={`p-4 rounded-xl border-2 shadow-md ${statusInfo.colorClass}`}>
                        <div className="flex items-center">
                            <LucideIcon name={statusInfo.icon} className={`w-6 h-6 mr-3 text-${statusInfo.color}-600`} />
                            <p className={`font-semibold text-lg text-${statusInfo.color}-800`}>{statusInfo.text}</p>
                        </div>
                        {tripData.ESTADO === 'ASIGNADO' && (
                            <p className="mt-2 text-sm text-gray-600 flex items-center">
                                <LucideIcon name="map" className="w-4 h-4 mr-1"/>
                                El chofer está en camino.
                                <a 
                                    href={`https://www.google.com/maps/dir/?api=1&destination=${tripData.DESTINO_DIRECCION}&travelmode=driving`} 
                                    target="_blank" 
                                    rel="noopener noreferrer" 
                                    className="text-indigo-600 hover:underline ml-2"
                                >
                                    Ver Mapa
                                </a>
                            </p>
                        )}
                        <p className="mt-2 text-sm text-gray-600">
                             Pedido ID: <span className="font-mono text-xs text-gray-500">{tripData.ID_PEDIDO}</span>
                        </p>
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-inner border">
                        <p className="text-sm font-medium text-gray-600">Origen:</p>
                        <p className="font-semibold">{tripData.ORIGEN_DIRECCION}</p>
                        <p className="text-sm font-medium text-gray-600 mt-2">Destino:</p>
                        <p className="font-semibold">{tripData.DESTINO_DIRECCION}</p>
                    </div>

                    {!isFinished && (
                        <button
                            onClick={onCancel}
                            className="w-full p-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition duration-300 transform hover:scale-[1.01]"
                        >
                            <LucideIcon name="x" className="w-5 h-5 mr-2 inline-block" />
                            Cancelar Viaje
                        </button>
                    )}
                    {isFinished && (
                         <p className="text-sm text-center text-gray-500 pt-2">Puedes cerrar esta ventana.</p>
                    )}
                </div>
            );
        };


        // =================================================================
        // COMPONENTE PRINCIPAL (App)
        // =================================================================
        const App = () => {
            const [authState, setAuthState] = useState({ 
                isLoading: true, 
                db: null, 
                auth: null, 
                userId: null 
            });
            const [tripData, setTripData] = useState(null); // null, or { ID_PEDIDO, ESTADO, ... }
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [formData, setFormData] = useState({
                name: '',
                phone: '',
                pickupLocation: '',
                pickupAddress: '',
                dropoffLocation: '',
                dropoffAddress: '',
            });
            const [tomTomSuggestions, setTomTomSuggestions] = useState([]);

            // 1. Inicialización de Firebase y Autenticación
            useEffect(() => {
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    setAuthState(prev => ({ ...prev, isLoading: false }));
                    return;
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            // Intenta sign-in con token o anónimo
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase auth error:", error);
                            }
                        }
                        
                        // Si ya tenemos un usuario (autenticado o anónimo)
                        if (auth.currentUser) {
                             const userId = auth.currentUser.uid;
                             setAuthState({ isLoading: false, db, auth, userId });
                        }
                    });

                    return () => unsubscribe(); // Limpiar listener
                } catch (e) {
                    console.error("Failed to initialize Firebase:", e);
                    setAuthState(prev => ({ ...prev, isLoading: false }));
                }
            }, []);

            // 2. Monitoreo de Solicitud de Viaje (solo si hay un viaje en curso)
            useEffect(() => {
                if (!authState.db || !tripData || !tripData.ID_PEDIDO) return;

                const db = authState.db;
                const tripId = tripData.ID_PEDIDO;

                // Path público donde el cliente escribe y el chofer lee
                const tripRef = doc(db, `artifacts/${appId}/public/data/tripRequests`, tripId);
                
                console.log(`Monitoring trip: ${tripId}`);

                const unsubscribe = onSnapshot(tripRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setTripData(prev => ({ ...prev, ...docSnap.data() }));
                    } else {
                        // El documento fue borrado (ej: el admin lo archivó) o cancelado.
                        if (tripData.ESTADO !== 'FINALIZADO' && tripData.ESTADO !== 'CANCELLED') {
                            setTripData(prev => ({...prev, ESTADO: 'CANCELLED'}));
                        }
                    }
                }, (error) => {
                    console.error("Error monitoring trip:", error);
                    // Esto suele ser un error de permisos (403), pero el nuevo path público debería evitarlo.
                });

                return () => unsubscribe(); // Limpiar listener
            }, [authState.db, tripData ? tripData.ID_PEDIDO : null]); 


            // 3. Lógica de Autocompletado de TomTom
            const fetchSuggestions = useCallback(debounce(async (query, field) => {
                if (query.length < 3) {
                    setTomTomSuggestions([]);
                    return;
                }
                
                try {
                    const response = await fetch(`https://api.tomtom.com/search/2/search/${encodeURIComponent(query)}.json?key=${TOMTOM_API_KEY}&language=es-ES&limit=5&countrySet=AR`);
                    if (!response.ok) throw new Error('TomTom API request failed');

                    const data = await response.json();
                    
                    const suggestions = data.results.map(result => ({
                        address: result.address.freeformAddress,
                        position: {
                            lat: result.position.lat,
                            lon: result.position.lon,
                        }
                    }));
                    setTomTomSuggestions(suggestions);

                } catch (error) {
                    console.error("Error fetching TomTom suggestions:", error);
                    setTomTomSuggestions([]);
                }
            }, 500), [TOMTOM_API_KEY]); // Debounce y memoize la función de búsqueda


            const handleSearch = (name, value) => {
                if (name === 'pickupSearch') {
                    setFormData(prev => ({ ...prev, pickupAddress: value, pickupLocation: '' }));
                    fetchSuggestions(value, 'pickup');
                } else if (name === 'dropoffSearch') {
                    setFormData(prev => ({ ...prev, dropoffAddress: value, dropoffLocation: '' }));
                    fetchSuggestions(value, 'dropoff');
                }
            };
            

            // 4. Envío de Solicitud
            const handleSubmit = async (e, localData) => {
                e.preventDefault();
                if (!authState.db || !formData.pickupLocation || !formData.dropoffLocation) {
                    console.error("App not ready or locations incomplete.");
                    return;
                }

                setIsSubmitting(true);
                
                const newTrip = {
                    CLIENTE_REF_DNI: localData.name, // Usamos el nombre como ID temporal
                    FECHA_HORA_PEDIDO: serverTimestamp(),
                    ORIGEN_UBICACION: formData.pickupLocation,
                    ORIGEN_DIRECCION: formData.pickupAddress,
                    DESTINO_UBICACION: formData.dropoffLocation,
                    DESTINO_DIRECCION: formData.dropoffAddress,
                    TIPO_VIAJE: 'Standard',
                    ESTADO: 'PENDING',
                    CHOFER_ASIGNADO_REF: '', // Se llenará en AppSheet
                    FARE_SIMULATED: DEFAULT_FARE,
                };

                try {
                    // Guardar en la colección pública de solicitudes de viaje
                    const requestsCollectionRef = collection(authState.db, `artifacts/${appId}/public/data/tripRequests`);
                    const docRef = await addDoc(requestsCollectionRef, newTrip);
                    
                    // Almacenar el ID y estado inicial para monitoreo
                    setTripData({
                        ID_PEDIDO: docRef.id,
                        ...newTrip
                    });
                    
                } catch (error) {
                    console.error("Error submitting trip:", error);
                    alert("Error al solicitar el viaje. Intenta de nuevo."); // Usamos alert temporalmente solo para feedback inmediato al usuario
                } finally {
                    setIsSubmitting(false);
                }
            };

            // 5. Cancelación de Viaje (Actualiza el documento público)
            const handleCancel = async () => {
                if (!authState.db || !tripData || !tripData.ID_PEDIDO) return;

                const db = authState.db;
                const tripId = tripData.ID_PEDIDO;

                if (confirm("¿Estás seguro de que quieres cancelar el viaje?")) {
                    try {
                        const tripRef = doc(db, `artifacts/${appId}/public/data/tripRequests`, tripId);
                        await setDoc(tripRef, { ESTADO: 'CANCELLED' }, { merge: true });
                        setTripData(prev => ({ ...prev, ESTADO: 'CANCELLED' }));
                    } catch (error) {
                        console.error("Error cancelling trip:", error);
                    }
                }
            };


            if (authState.isLoading) {
                return (
                    <div className="flex justify-center items-center h-screen">
                        <div className="spinner mr-3"></div>
                        <p className="text-lg text-gray-700">Conectando con el servicio...</p>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto p-4 bg-white rounded-xl shadow-2xl mt-8 mb-8">
                    <header className="text-center mb-6">
                        <LucideIcon name="map-pin" className="w-8 h-8 mx-auto text-indigo-600 mb-2" />
                        <h1 className="text-3xl font-extrabold text-gray-900">TAXI DEL VALLE</h1>
                        <p className="text-sm text-gray-500">Solicitud de Viaje</p>
                    </header>
                    
                    {tripData && tripData.ID_PEDIDO && tripData.ESTADO !== 'FINALIZADO' && tripData.ESTADO !== 'CANCELLED' ? (
                        <StatusMonitor tripData={tripData} onCancel={handleCancel} />
                    ) : (
                        <RequestForm 
                            isSubmitting={isSubmitting} 
                            onSubmit={handleSubmit} 
                            tomTomSuggestions={tomTomSuggestions} 
                            onSearch={handleSearch} 
                            setFormData={setFormData}
                        />
                    )}
                    
                    {/* Mensaje de finalización o cancelación */}
                    {(tripData && (tripData.ESTADO === 'FINALIZADO' || tripData.ESTADO === 'CANCELLED')) && (
                        <div className={`p-4 mt-6 rounded-xl border-2 ${tripData.ESTADO === 'FINALIZADO' ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'}`}>
                            <p className="font-semibold text-center text-gray-700">
                                {tripData.ESTADO === 'FINALIZADO' ? 'Viaje Completado' : 'Viaje Cancelado'}
                            </p>
                            <button
                                onClick={() => setTripData(null)}
                                className="mt-3 w-full p-3 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition duration-300"
                            >
                                <LucideIcon name="plus" className="w-5 h-5 mr-2 inline-block" />
                                Solicitar Nuevo Viaje
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // Renderizado de la App
        const rootElement = document.getElementById('root');
        if (rootElement) {
            ReactDOM.createRoot(rootElement).render(<App />);
        }

    </script>
</body>
</html>
