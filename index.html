<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi del Valle - Pedido</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Inter para estética moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Carga de Iconos (Lucide Icons) -->
    <script type="module">
        import { createIcons, MapPin, LocateFixed, Car, Send, List } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';
        createIcons({ icons: { MapPin, LocateFixed, Car, Send, List } });
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        #map { height: 65vh; width: 100%; border-radius: 0 0 1rem 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .leaflet-container { z-index: 1; }
        .fab-button { transition: background-color 0.3s, transform 0.1s; }
        .fab-button:active { transform: scale(0.95); }
    </style>
</head>
<body class="min-h-screen antialiased">
    <!-- Contenedor Principal -->
    <div id="app-container" class="max-w-md mx-auto bg-white min-h-screen shadow-lg">
        <!-- Header y Botón de Historial -->
        <header class="p-4 bg-yellow-500 text-white flex justify-between items-center rounded-b-xl">
            <h1 class="text-xl font-bold">Taxi del Valle <i data-lucide="car" class="inline-block w-6 h-6"></i></h1>
            <button id="show-history-btn" class="bg-yellow-600 hover:bg-yellow-700 p-2 rounded-full shadow-md transition duration-150">
                <i data-lucide="list" class="w-5 h-5"></i>
            </button>
        </header>
        <!-- Banner de Bienvenida -->
        <div id="status-message" class="px-4 py-3 bg-indigo-100 text-indigo-800 font-semibold text-center text-sm border-b border-indigo-200 shadow-sm">
            Cargando el mapa y servicios...
        </div>
        <!-- Area de la App (Mapa y Controles) -->
        <main id="main-content" class="relative">
            <!-- Contenedor del Mapa -->
            <div id="map" class="mb-4"></div>
            <!-- Botón de Geolocalización Flotante -->
            <button id="locate-me-btn" class="absolute top-4 right-4 z-10 bg-white p-3 rounded-full shadow-lg border border-gray-200 hover:bg-gray-100 transition duration-150">
                <i data-lucide="locate-fixed" class="w-5 h-5 text-indigo-600"></i>
            </button>
            <!-- Panel de Control y Formulario -->
            <div class="px-4 pb-20">
                <div class="space-y-4 p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                    <!-- Indicador de Origen -->
                    <div class="flex items-center space-x-3 p-3 bg-indigo-50 rounded-lg">
                        <i data-lucide="locate-fixed" class="w-5 h-5 text-indigo-600 flex-shrink-0"></i>
                        <div class="flex-grow">
                            <label class="text-xs font-medium text-indigo-600">Origen (Recogida)</label>
                            <p id="origin-display" class="font-semibold text-gray-800 text-sm truncate">Cargando ubicación actual...</p>
                        </div>
                    </div>
                    <!-- Indicador y Campo de Destino -->
                    <div class="flex items-center space-x-3 p-3 bg-red-50 rounded-lg border-2 border-red-200">
                        <i data-lucide="map-pin" class="w-5 h-5 text-red-600 flex-shrink-0"></i>
                        <div class="flex-grow">
                            <label class="text-xs font-medium text-red-600">Destino (Toca el mapa)</label>
                            <input type="text" id="destination-address" placeholder="Esperando selección en el mapa..." class="w-full font-semibold text-gray-800 text-sm bg-red-50 focus:outline-none" readonly>
                            <span id="destination-coords" class="text-xs text-red-500 hidden"></span>
                        </div>
                    </div>
                    <!-- Botón de Pedido -->
                    <button id="request-trip-btn" disabled class="w-full flex items-center justify-center space-x-2 py-3 px-4 bg-indigo-500 text-white font-bold rounded-xl shadow-md disabled:bg-indigo-300 hover:bg-indigo-600 transition duration-150">
                        <i data-lucide="send" class="w-5 h-5"></i>
                        <span>Selecciona Origen y Destino</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Carga de Leaflet CSS y JS (Librería de Mapas) -->
    <!-- MOVIMIENTO CRÍTICO: Mover los scripts de Leaflet aquí, antes del script principal, asegura que la variable L esté definida. -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20n63W4ai0B8n7zL8dE5P5wzJbuvjt+YF6r7o/qBCV0=" crossorigin=""></script>
    
    <!-- Script Principal de la Aplicación y Lógica del Mapa -->
    <script>
        let map;
        let originMarker;
        let destinationMarker;
        let currentPosition = null;
        let destinationCoords = null;
        let destinationAddress = '';

        // Función para mostrar mensajes de estado
        function displayMessage(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = 'px-4 py-3 font-semibold text-center text-sm border-b border-indigo-200 shadow-sm';

            if (type === 'error') {
                statusDiv.classList.add('bg-red-100', 'text-red-800', 'border-red-200');
                statusDiv.classList.remove('bg-indigo-100', 'text-indigo-800');
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-100', 'text-green-800', 'border-green-200');
                statusDiv.classList.remove('bg-indigo-100', 'text-indigo-800');
            } else {
                statusDiv.classList.add('bg-indigo-100', 'text-indigo-800');
            }
        }

        // ====================================================================
        // INICIALIZACIÓN DE FIREBASE Y FUNCIONES DE GUARDADO (CRÍTICO)
        // ====================================================================

        // Variables globales proporcionadas por el entorno (Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;

        // Carga de Firebase SDKs
        const loadScript = (src) => new Promise(resolve => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            document.head.appendChild(script);
        });

        const loadFirebase = async () => {
            await Promise.all([
                loadScript("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"),
                loadScript("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"),
                loadScript("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js")
            ]);

            if (window.firebase && firebaseConfig) {
                const { initializeApp } = window.firebase;
                const { getFirestore, collection, addDoc } = window.firebase.firestore;
                const { getAuth, signInAnonymously, signInWithCustomToken } = window.firebase.auth;

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Autenticación
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Firebase Auth: Usuario autenticado con token.");
                    } catch (error) {
                        console.error("Firebase Auth Error con token:", error);
                        await signInAnonymously(auth);
                        console.log("Firebase Auth: Fallback a Anónimo.");
                    }
                } else {
                    await signInAnonymously(auth);
                    console.log("Firebase Auth: Sesión Anónima iniciada.");
                }

                displayMessage("Mapa interactivo y servicios de pedido listos.", 'success');
            } else {
                displayMessage("Error: No se encontró la configuración de Firebase.", 'error');
            }
        };

        // Función global para guardar el pedido en Firestore (accesible por el botón)
        window.savePedidoToFirestore = async function(pedidoData) {
            if (!db || !auth.currentUser) {
                displayMessage("Error: Conexión a Firebase o autenticación fallida.", 'error');
                return false;
            }
            
            try {
                // La colección se almacena en el área pública para que AppSheet pueda acceder
                const collectionPath = `artifacts/${appId}/public/data/pedidos`;
                const docRef = await addDoc(collection(db, collectionPath), {
                    ...pedidoData,
                    userId: auth.currentUser.uid, // ID del cliente que pide
                    createdAt: new Date().toISOString(),
                    estado: "PENDIENTE" // Estado inicial del pedido
                });
                console.log("Pedido guardado con ID:", docRef.id);
                return true;
            } catch (e) {
                console.error("Error guardando el pedido en Firestore: ", e);
                displayMessage("Error al enviar el pedido. Intente de nuevo.", 'error');
                return false;
            }
        };

        // ====================================================================
        // FIN: INICIALIZACIÓN DE FIREBASE
        // ====================================================================


        // Función para inicializar el mapa Leaflet
        function initMap() {
            // L.map ahora debe estar disponible porque el script de Leaflet se carga antes.
            map = L.map('map').setView([-38.9517, -68.0617], 13); // Centrado en Neuquén (ejemplo)

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Icono de origen (azul)
            const originIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#3b82f6" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 22 13.5 22 10.2A7.5 7.5 0 0 0 12 3a7.5 7.5 0 0 0-10 7.2c0 3.3 4.7 6.8 10 11.5z"/></svg>'),
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -28]
            });

            // Icono de destino (rojo)
            const destinationIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="#ef4444" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 22 13.5 22 10.2A7.5 7.5 0 0 0 12 3a7.5 7.5 0 0 0-10 7.2c0 3.3 4.7 6.8 10 11.5z"/></svg>'),
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -28]
            });

            // 1. Manejo del Origen (Geolocalización)
            map.locate({ setView: true, maxZoom: 16 });

            map.on('locationfound', (e) => {
                const latlng = e.latlng;
                currentPosition = { lat: latlng.lat, lng: latlng.lng };

                if (originMarker) {
                    originMarker.setLatLng(latlng);
                } else {
                    originMarker = L.marker(latlng, { icon: originIcon }).addTo(map)
                        .bindPopup("Ubicación de Origen (Tú)").openPopup();
                }

                // Reverse Geocoding para obtener la dirección de origen
                reverseGeocode(latlng, 'origin-display', (address) => {
                    document.getElementById('origin-display').textContent = address;
                    updateRequestButton();
                });
            });

            map.on('locationerror', (e) => {
                console.error("Error de geolocalización:", e.message);
                displayMessage("Error al obtener ubicación. Mueve el mapa para el origen.", 'error');
            });

            // 2. Manejo del Destino (Clic en el Mapa)
            map.on('click', (e) => {
                const latlng = e.latlng;
                destinationCoords = { lat: latlng.lat, lng: latlng.lng };

                if (destinationMarker) {
                    destinationMarker.setLatLng(latlng);
                } else {
                    destinationMarker = L.marker(latlng, { icon: destinationIcon }).addTo(map)
                        .bindPopup("Destino").openPopup();
                }

                // Reverse Geocoding para obtener la dirección de destino
                reverseGeocode(latlng, 'destination-address', (address) => {
                    destinationAddress = address;
                    document.getElementById('destination-address').value = address;
                    document.getElementById('destination-coords').textContent = `${latlng.lat}, ${latlng.lng}`;
                    updateRequestButton();
                });
            });
        }

        // Simulación de Reverse Geocoding (Usando un servicio externo o mock)
        async function reverseGeocode(latlng, elementId, callback) {
            // NOTA: En un entorno de producción, aquí usarías Google Maps Geocoding API o Nominatim
            // Usamos Nominatim (OpenStreetMap) como mock para obtener una dirección
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18&addressdetails=1`;
            
            try {
                const response = await fetch(url, { headers: { 'User-Agent': 'TaxiDelValleApp' } });
                const data = await response.json();
                const address = data.display_name || `Lat: ${latlng.lat.toFixed(4)}, Lon: ${latlng.lng.toFixed(4)}`;
                callback(address);
            } catch (error) {
                console.error("Error en Geocoding:", error);
                callback(`Lat: ${latlng.lat.toFixed(4)}, Lon: ${latlng.lng.toFixed(4)}`);
            }
        }

        // Habilita/Deshabilita el botón de pedido
        function updateRequestButton() {
            const btn = document.getElementById('request-trip-btn');
            
            if (currentPosition && destinationCoords) {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i><span> Solicitar Viaje Ahora</span>';
                btn.classList.replace('disabled:bg-indigo-300', 'bg-indigo-500');
            } else {
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i><span> Selecciona Origen y Destino</span>';
                btn.classList.replace('bg-indigo-500', 'disabled:bg-indigo-300');
            }
        }

        // Inicialización y Manejadores de Eventos
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar Firebase antes de cualquier interacción de guardado
            loadFirebase();
            initMap();

            document.getElementById('locate-me-btn').addEventListener('click', () => {
                if (map) {
                    map.locate({ setView: true, maxZoom: 16 });
                }
            });

            // ===============================================================
            // Manejador del Botón de Pedido (USA FIREBASE)
            // ===============================================================
            document.getElementById('request-trip-btn').addEventListener('click', async () => {
                if (!currentPosition || !destinationCoords) {
                    displayMessage("Por favor, selecciona tanto el origen como el destino.", 'error');
                    return;
                }

                // Construir el objeto de datos del pedido
                const pedidoData = {
                    origen_lat: currentPosition.lat,
                    origen_lng: currentPosition.lng,
                    origen_address: document.getElementById('origin-display').textContent,
                    destino_lat: destinationCoords.lat,
                    destino_lng: destinationCoords.lng,
                    destino_address: destinationAddress,
                    // Otros campos iniciales
                    cliente_ref: auth.currentUser ? auth.currentUser.uid : 'anonimo',
                    timestamp: new Date().toISOString(),
                };

                // CRÍTICO: Llamar a la función de guardado de Firebase
                const success = await window.savePedidoToFirestore(pedidoData);

                if (success) {
                    displayMessage('✅ ¡Pedido enviado con éxito! Buscando chofer...', 'success');
                    
                    // Lógica de UI después del éxito
                    document.getElementById('request-trip-btn').disabled = true;
                    document.getElementById('request-trip-btn').innerHTML = 'Pedido Enviado. Esperando Asignación...';
                    
                } else {
                    // El error ya se maneja en savePedidoToFirestore
                }
            });
            // ===============================================================
        });
    </script>
</body>
</html>
