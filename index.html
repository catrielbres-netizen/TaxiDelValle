import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, addDoc, deleteDoc } from 'firebase/firestore';
// Iconos de Lucide
import { MapPin, Target, Car, User, Phone, DollarSign, Clock, Truck, CheckCircle, XCircle, Map } from 'lucide-react'; 

// Variables globales proporcionadas por el entorno (MANDATORIO)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'client-app-id';
// FIX: Corregido el typo en el nombre de la variable de referencia
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Helper para parsear la configuración de Firebase de forma segura
const safeParseConfig = () => {
    if (typeof __firebase_config === 'string' && __firebase_config.trim() !== '') {
        try {
            return JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Error al parsear la configuración de Firebase:", e);
            return {};
        }
    }
    return {};
};
const firebaseConfig = safeParseConfig();


// --- CONFIGURACIÓN DE TOMTOM ---
// Clave de TomTom proporcionada por el usuario
const TOMTOM_API_KEY = "qfiNAZGwcmXAFKdmxn9eggudv5Hw87tT"; 
const COUNTRY_CODE = 'ARG'; // Asumimos Argentina por el contexto del proyecto

// Estado simulado del cliente (para demostrar la funcionalidad)
const DEFAULT_CLIENT_NAME = 'Juan Pérez';
const DEFAULT_CLIENT_PHONE = '+54 9 11 1234 5678';
const DEFAULT_FARE = '$ 2500 ARS'; // Tarifa simulada

// --- UTILS DE FIREBASE Y ESTADO DE LA APP ---
const initialAppState = {
  db: null,
  auth: null,
  userId: null,
  isAuthReady: false,
};

// Componente principal de la aplicación del Cliente
const App = () => {
  const [app, setApp] = useState(initialAppState);
  const [loading, setLoading] = useState(true);
  
  // Datos del formulario
  const [pickup, setPickup] = useState('Avenida Corrientes 800, Buenos Aires');
  const [dropoff, setDropoff] = useState('Obelisco, Buenos Aires');
  const [clientName, setClientName] = useState(DEFAULT_CLIENT_NAME);
  const [clientPhone, setClientPhone] = useState(DEFAULT_CLIENT_PHONE);
  
  // Estado de la solicitud de viaje
  const [currentTripId, setCurrentTripId] = useState(null);
  const [currentTripStatus, setCurrentTripStatus] = useState('IDLE'); // IDLE, PENDING, ACCEPTED, WAITING_PICKUP, EN_ROUTE, COMPLETED, CANCELLED
  const [driverDetails, setDriverDetails] = useState(null);

  // ESTADOS PARA EL AUTOCOMPLETADO DE TOMTOM
  const [pickupSuggestions, setPickupSuggestions] = useState([]);
  const [dropoffSuggestions, setDropoffSuggestions] = useState([]);
  const [isSearchingPickup, setIsSearchingPickup] = useState(false);
  const [isSearchingDropoff, setIsSearchingDropoff] = useState(false);

  // 1. Inicialización de Firebase y Autenticación
  useEffect(() => {
    try {
      if (Object.keys(firebaseConfig).length === 0) {
        console.error("Firebase configuration is missing or invalid. Check the config string.");
        setLoading(false);
        return;
      }
      
      const firebaseApp = initializeApp(firebaseConfig);
      const dbInstance = getFirestore(firebaseApp);
      const authInstance = getAuth(firebaseApp);

      setApp(prev => ({ ...prev, db: dbInstance, auth: authInstance }));

      const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
        if (user) {
          const userId = user.uid;
          setApp(prev => ({ ...prev, userId, isAuthReady: true }));
          console.log(`[Client] Authenticated. User ID: ${userId}`);
        } else {
          try {
            if (initialAuthToken) {
              await signInWithCustomToken(authInstance, initialAuthToken);
            } else {
              await signInAnonymously(authInstance);
            }
          } catch (e) {
            console.error("[Client] Error during authentication:", e);
          } finally {
             const tempUserId = authInstance.currentUser?.uid || crypto.randomUUID();
             setApp(prev => ({ ...prev, userId: tempUserId, isAuthReady: true }));
          }
        }
        setLoading(false);
      });

      return () => unsubscribe();
    } catch (e) {
      console.error("[Client] Failed to initialize Firebase:", e);
      setLoading(false);
    }
  }, [initialAuthToken]); // Se añade initialAuthToken como dependencia para consistencia

  // --- FUNCIÓN DE BÚSQUEDA DE SUGERENCIAS TOMTOM ---
  const fetchSuggestions = useCallback(async (query, setSuggestions, setLoading) => {
    if (TOMTOM_API_KEY === "YOUR_TOMTOM_API_KEY_AQUI" || !query || query.length < 3) {
        setSuggestions([]);
        return;
    }
    
    setLoading(true);

    // Lógica de reintento con backoff exponencial
    for (let attempt = 0; attempt < 3; attempt++) {
        try {
            const encodedQuery = encodeURIComponent(query);
            // TomTom Search API (Fuzzy Search) - Limitamos a 5 resultados
            const apiUrl = `https://api.tomtom.com/search/2/search/${encodedQuery}.json?key=${TOMTOM_API_KEY}&countrySet=${COUNTRY_CODE}&limit=5`;

            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            
            const suggestions = data.results
                ? data.results.map(result => result.address.freeformAddress)
                : [];
            
            setSuggestions(suggestions);
            setLoading(false);
            return; // Éxito, salimos de la función

        } catch (error) {
            console.error(`[TomTom API] Intento ${attempt + 1} fallido:`, error);
            if (attempt < 2) {
                const delay = Math.pow(2, attempt) * 1000;
                await new Promise(res => setTimeout(res, delay));
            } else {
                setSuggestions(['Error de conexión. Intente una búsqueda más específica.']);
                setLoading(false);
            }
        }
    }
  }, []); // Dependencias vacías para useCallback

  // --- EFECTOS DE DEBOUNCE PARA AUTOCOMPLETADO ---
  
  // Debounce para Origen
  useEffect(() => {
    const handler = setTimeout(() => {
        fetchSuggestions(pickup, setPickupSuggestions, setIsSearchingPickup);
    }, 500); // Espera 500ms después de que el usuario deja de escribir

    return () => clearTimeout(handler);
  }, [pickup, fetchSuggestions]);

  // Debounce para Destino
  useEffect(() => {
    const handler = setTimeout(() => {
        fetchSuggestions(dropoff, setDropoffSuggestions, setIsSearchingDropoff);
    }, 500); // Espera 500ms después de que el usuario deja de escribir

    return () => clearTimeout(handler);
  }, [dropoff, fetchSuggestions]);


  // 2. Monitoreo de la solicitud de viaje activa
  useEffect(() => {
    if (!app.db || !currentTripId) return;

    // La solicitud de viaje está en la colección pública, monitoreamos los cambios
    const tripRequestDocRef = doc(app.db, 'artifacts', appId, 'public', 'data', 'tripRequests', currentTripId);

    const unsubscribe = onSnapshot(tripRequestDocRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        // Usar tripStatus si existe, sino el status principal
        setCurrentTripStatus(data.tripStatus || data.status); 
        
        if (data.driverName) {
            setDriverDetails({
                name: data.driverName,
                id: data.driverId,
            });
        }
        
        console.log(`[Client] Trip Status Update: ${data.tripStatus || data.status}`);

        // Manejar el final del viaje para resetear la vista
        if (data.status === 'FINALIZED' || data.status === 'REJECTED_BY_DRIVER') {
            // El usuario debe presionar un botón para resetear
        }

      } else {
        // Si el documento es eliminado por alguna razón, se resetea
        if (currentTripStatus !== 'IDLE') {
            setCurrentTripStatus('CANCELLED'); // Forzar estado cancelado si se pierde la referencia
            // Mantenemos currentTripId para mostrar el monitor de estado CANCELLED/REJECTED
        }
      }
    }, (error) => {
      console.error("[Client] Error monitoring trip status:", error);
    });

    return () => unsubscribe();
  }, [app.db, currentTripId, currentTripStatus]);

  // Función para solicitar un viaje
  const requestTrip = useCallback(async () => {
    if (!app.db || currentTripStatus !== 'IDLE') return;

    setCurrentTripStatus('PENDING');

    const requestsCollectionRef = collection(app.db, 'artifacts', appId, 'public', 'data', 'tripRequests');

    const newTripData = {
        clientId: app.userId,
        clientName,
        clientPhone,
        pickup,
        dropoff,
        fare: DEFAULT_FARE,
        status: 'PENDING', // Estado que el chofer monitorea
        tripStatus: 'PENDING', // Estado de seguimiento del cliente
        timestamp: Date.now(),
    };

    try {
        const docRef = await addDoc(requestsCollectionRef, newTripData);
        setCurrentTripId(docRef.id);
    } catch (e) {
      console.error("[Client] Error creating trip request:", e);
      setCurrentTripStatus('IDLE');
    }
  }, [app.db, app.userId, clientName, clientPhone, pickup, dropoff, currentTripStatus]);
  
  // Función para limpiar el estado después de un viaje finalizado/cancelado
  const resetTrip = () => {
      setCurrentTripId(null);
      setCurrentTripStatus('IDLE');
      setDriverDetails(null);
  };
  
  // Función para cancelar el viaje (solo si está pendiente)
  const cancelTrip = useCallback(async () => {
      if (!app.db || !currentTripId || currentTripStatus !== 'PENDING') return;

      const tripRequestDocRef = doc(app.db, 'artifacts', appId, 'public', 'data', 'tripRequests', currentTripId);

      try {
          // Eliminamos el documento para que desaparezca de la cola del chofer
          await deleteDoc(tripRequestDocRef);
          setCurrentTripStatus('CANCELLED');
          setCurrentTripId(null);
      } catch (e) {
           console.error("[Client] Error canceling trip:", e);
      }
  }, [app.db, currentTripId, currentTripStatus]);

  // --- COMPONENTES DE VISTA ---
  
  const TripForm = () => (
      <div className="space-y-4">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Detalles del Viaje</h2>
          
          {/* Origen */}
          <div className="relative z-10">
              <div className="flex items-center bg-gray-100 p-3 rounded-xl border border-gray-200">
                  <MapPin size={20} className="text-blue-500 mr-3 flex-shrink-0" />
                  <input 
                      type="text" 
                      placeholder="Origen (Dirección de Recogida)"
                      value={pickup}
                      onChange={(e) => {
                          setPickup(e.target.value);
                          setPickupSuggestions([]); // Limpiar sugerencias al escribir
                      }}
                      className="w-full bg-transparent outline-none text-gray-700 font-medium"
                      required
                  />
                  {isSearchingPickup && <Clock size={16} className="text-gray-400 animate-spin ml-2"/>}
              </div>
              
              {/* Sugerencias de Origen */}
              {pickupSuggestions.length > 0 && (
                  <ul className="absolute w-full mt-1 bg-white border border-gray-300 rounded-xl shadow-lg max-h-40 overflow-y-auto">
                      {pickupSuggestions.map((suggestion, index) => (
                          <li
                              key={index}
                              onClick={() => {
                                  setPickup(suggestion);
                                  setPickupSuggestions([]);
                              }}
                              className="p-3 text-sm text-gray-800 cursor-pointer hover:bg-blue-100 transition duration-150"
                          >
                              {suggestion}
                          </li>
                      ))}
                  </ul>
              )}
          </div>
          
          {/* Destino */}
          <div className="relative z-0">
              <div className="flex items-center bg-gray-100 p-3 rounded-xl border border-gray-200">
                  <Target size={20} className="text-red-500 mr-3 flex-shrink-0" />
                  <input 
                      type="text" 
                      placeholder="Destino"
                      value={dropoff}
                      onChange={(e) => {
                          setDropoff(e.target.value);
                          setDropoffSuggestions([]); // Limpiar sugerencias al escribir
                      }}
                      className="w-full bg-transparent outline-none text-gray-700 font-medium"
                      required
                  />
                  {isSearchingDropoff && <Clock size={16} className="text-gray-400 animate-spin ml-2"/>}
              </div>
              
              {/* Sugerencias de Destino */}
              {dropoffSuggestions.length > 0 && (
                  <ul className="absolute w-full mt-1 bg-white border border-gray-300 rounded-xl shadow-lg max-h-40 overflow-y-auto">
                      {dropoffSuggestions.map((suggestion, index) => (
                          <li
                              key={index}
                              onClick={() => {
                                  setDropoff(suggestion);
                                  setDropoffSuggestions([]);
                              }}
                              className="p-3 text-sm text-gray-800 cursor-pointer hover:bg-red-100 transition duration-150"
                          >
                              {suggestion}
                          </li>
                      ))}
                  </ul>
              )}
          </div>

          <h2 className="text-xl font-bold text-gray-800 pt-4 mb-4 border-t border-gray-200">Tu Contacto</h2>
          
          {/* Nombre */}
          <div className="flex items-center bg-gray-100 p-3 rounded-xl border border-gray-200">
              <User size={20} className="text-gray-500 mr-3 flex-shrink-0" />
              <input 
                  type="text" 
                  placeholder="Tu Nombre"
                  value={clientName}
                  onChange={(e) => setClientName(e.target.value)}
                  className="w-full bg-transparent outline-none text-gray-700 font-medium"
                  required
              />
          </div>
          
          {/* Teléfono */}
          <div className="flex items-center bg-gray-100 p-3 rounded-xl border border-gray-200">
              <Phone size={20} className="text-gray-500 mr-3 flex-shrink-0" />
              <input 
                  type="tel" 
                  placeholder="Teléfono de Contacto"
                  value={clientPhone}
                  onChange={(e) => setClientPhone(e.target.value)}
                  className="w-full bg-transparent outline-none text-gray-700 font-medium"
                  required
              />
          </div>
          
          {/* Tarifa Simulada */}
          <div className="mt-6 p-4 bg-indigo-50 rounded-xl flex justify-between items-center">
              <span className="text-lg font-bold text-indigo-700 flex items-center">
                  <DollarSign size={20} className="mr-2"/> Tarifa Estimada
              </span>
              <span className="text-2xl font-extrabold text-indigo-800">{DEFAULT_FARE}</span>
          </div>
          
          {/* Botón de Solicitud */}
          <button
              onClick={requestTrip}
              disabled={currentTripStatus !== 'IDLE' || !pickup || !dropoff}
              className={`w-full py-4 mt-6 rounded-xl font-bold text-white transition duration-300 transform hover:scale-[1.01] flex items-center justify-center ${
                  currentTripStatus === 'IDLE' && pickup && dropoff
                      ? 'bg-blue-600 hover:bg-blue-700 shadow-lg'
                      : 'bg-gray-400 cursor-not-allowed'
              }`}
          >
              <Car size={20} className="mr-2" />
              {currentTripStatus === 'IDLE' ? 'Solicitar Viaje' : 'Viaje en Proceso...'}
          </button>
      </div>
  );
  
  const StatusMonitor = () => {
    let statusText = '';
    let statusColor = 'bg-gray-500';
    let icon = Clock;
    let button = null;

    switch (currentTripStatus) {
        case 'PENDING':
            statusText = 'Buscando Chofer...';
            statusColor = 'bg-yellow-500';
            icon = Clock;
            button = (
                <button
                    onClick={cancelTrip}
                    className="w-full py-2 mt-4 rounded-xl font-bold text-white bg-red-500 hover:bg-red-600 transition"
                >
                    Cancelar Solicitud
                </button>
            );
            break;
        case 'ACCEPTED':
        case 'WAITING_PICKUP':
            statusText = `Chofer Asignado: ${driverDetails?.name || 'Cargando...'}`;
            statusColor = 'bg-indigo-600';
            icon = Truck;
            break;
        case 'EN_ROUTE':
            statusText = 'En Ruta a Destino';
            statusColor = 'bg-green-600';
            icon = Map; // Se corrigió a Map de lucide-react
            break;
        case 'FINALIZED':
        case 'COMPLETED':
            statusText = '¡Viaje Finalizado! Gracias.';
            statusColor = 'bg-blue-600';
            icon = CheckCircle;
            button = (
                <button
                    onClick={resetTrip}
                    className="w-full py-2 mt-4 rounded-xl font-bold text-white bg-blue-500 hover:bg-blue-600 transition"
                >
                    Nuevo Viaje
                </button>
            );
            break;
        case 'CANCELLED':
        case 'REJECTED_BY_DRIVER':
            statusText = 'Solicitud Cancelada/Rechazada. Intenta de nuevo.';
            statusColor = 'bg-red-600';
            icon = XCircle;
            button = (
                <button
                    onClick={resetTrip}
                    className="w-full py-2 mt-4 rounded-xl font-bold text-white bg-gray-500 hover:bg-gray-600 transition"
                >
                    Volver a Solicitar
                </button>
            );
            break;
        default:
            return null; // Si es IDLE, no mostramos el monitor
    }
      
    const CurrentIcon = icon;

    return (
        <div className="bg-white p-6 rounded-2xl shadow-2xl border-t-8 border-indigo-500 animate-pulse-fast">
            <div className={`p-4 rounded-xl text-white font-bold text-center flex items-center justify-center mb-4 ${statusColor}`}>
                <CurrentIcon size={24} className="mr-3"/>
                <span className="text-lg">{statusText}</span>
            </div>
            
            {driverDetails && (currentTripStatus === 'ACCEPTED' || currentTripStatus === 'WAITING_PICKUP' || currentTripStatus === 'EN_ROUTE') && (
                <div className="space-y-2 p-3 bg-gray-50 rounded-xl">
                    <p className="text-sm font-semibold text-gray-700 flex items-center"><User size={16} className="mr-2 text-indigo-500"/> Chofer: {driverDetails.name}</p>
                    <p className="text-xs text-gray-500 flex items-center"><Truck size={16} className="mr-2 text-indigo-500"/> ID: {driverDetails.id}</p>
                </div>
            )}
            
            <div className="mt-4 space-y-2 text-sm text-gray-600">
                <p className="flex items-center"><MapPin size={16} className="mr-2 text-blue-500"/> Origen: <span className="font-medium ml-1">{pickup}</span></p>
                <p className="flex items-center"><Target size={16} className="mr-2 text-red-500"/> Destino: <span className="font-medium ml-1">{dropoff}</span></p>
                <p className="flex items-center"><DollarSign size={16} className="mr-2 text-green-500"/> Tarifa: <span className="font-bold ml-1">{DEFAULT_FARE}</span></p>
            </div>
            
            {button}
        </div>
    );
  };
  
  // Vista de Carga
  if (loading || !app.isAuthReady) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center p-6 bg-white rounded-xl shadow-lg">
          <div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
          <p className="text-gray-600 font-semibold">Cargando aplicación y autenticando...</p>
        </div>
        <style jsx="true">{`
          .loader {
            border-top-color: #3b82f6; 
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
          }
          @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
          @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        `}</style>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 font-[Inter] flex flex-col items-center p-4 sm:p-6">
      <div className="w-full max-w-lg">
        {/* Encabezado */}
        <header className="text-center mb-6">
          <Car size={40} className="text-indigo-600 mx-auto mb-2" />
          <h1 className="text-3xl font-extrabold text-gray-900">Solicitar Viaje</h1>
          <p className="text-sm text-gray-500 mt-1">ID Cliente: <span className="font-mono text-xs p-1 bg-gray-200 rounded">{app.userId}</span></p>
        </header>
        
        {/* Contenido principal */}
        <div className="p-6 bg-white rounded-2xl shadow-xl">
            {currentTripStatus === 'IDLE' ? <TripForm /> : <StatusMonitor />}
        </div>
        
        {/* Footer */}
        <footer className="mt-10 text-center text-xs text-gray-400 p-4 border-t">
            <p>Módulo de Cliente (Firebase Real-Time) | Geocodificación TomTom Integrada</p>
        </footer>
      </div>
    </div>
  );
};

export default App;
