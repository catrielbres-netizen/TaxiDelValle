<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi del Valle - Pedido</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fuente Inter para estética moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Carga de Iconos (Lucide Icons) -->
    <script type="module">
        import { createIcons, MapPin, LocateFixed, Car, Send, List } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';
        createIcons({ icons: { MapPin, LocateFixed, Car, Send, List } });
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        /* CRÍTICO: Aseguramos que el contenedor del mapa tenga una altura definida */
        #map { height: 65vh; width: 100%; border-radius: 0 0 1rem 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .leaflet-container { z-index: 1; }
        .fab-button { transition: background-color 0.3s, transform 0.1s; }
        .fab-button:active { transform: scale(0.95); }
    </style>

    <!-- CRÍTICO: CARGA DE LEAFLET CSS EN EL HEAD -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body class="min-h-screen antialiased">
    <!-- Contenedor Principal -->
    <div id="app-container" class="max-w-md mx-auto bg-white min-h-screen shadow-lg">
        <!-- Header y Botón de Historial -->
        <header class="p-4 bg-yellow-500 text-white flex justify-between items-center rounded-b-xl">
            <h1 class="text-xl font-bold">Taxi del Valle <i data-lucide="car" class="inline-block w-6 h-6"></i></h1>
            <button id="show-history-btn" class="bg-yellow-600 hover:bg-yellow-700 p-2 rounded-full shadow-md transition duration-150">
                <i data-lucide="list" class="w-5 h-5"></i>
            </button>
        </header>
        <!-- Banner de Bienvenida -->
        <div id="status-message" class="px-4 py-3 bg-indigo-100 text-indigo-800 font-semibold text-center text-sm border-b border-indigo-200 shadow-sm">
            Inicializando aplicación...
        </div>
        <!-- Area de la App (Mapa y Controles) -->
        <main id="main-content" class="relative">
            <!-- Contenedor del Mapa -->
            <div id="map" class="mb-4"></div>
            <!-- Botón de Geolocalización Flotante -->
            <button id="locate-me-btn" class="absolute top-4 right-4 z-10 bg-white p-3 rounded-full shadow-lg border border-gray-200 hover:bg-gray-100 transition duration-150">
                <i data-lucide="locate-fixed" class="w-5 h-5 text-indigo-600"></i>
            </button>
            <!-- Panel de Control y Formulario -->
            <div class="px-4 pb-20">
                <div class="space-y-4 p-4 bg-white rounded-xl shadow-lg border border-gray-100">
                    <!-- Indicador de Origen -->
                    <div class="flex items-center space-x-3 p-3 bg-indigo-50 rounded-lg">
                        <i data-lucide="locate-fixed" class="w-5 h-5 text-indigo-600 flex-shrink-0"></i>
                        <div class="flex-grow">
                            <label class="text-xs font-medium text-indigo-600">Origen (Recogida)</label>
                            <p id="origin-display" class="font-semibold text-gray-800 text-sm truncate">Cargando ubicación actual...</p>
                        </div>
                    </div>
                    <!-- Indicador y Campo de Destino -->
                    <div class="flex items-center space-x-3 p-3 bg-red-50 rounded-lg border-2 border-red-200">
                        <i data-lucide="map-pin" class="w-5 h-5 text-red-600 flex-shrink-0"></i>
                        <div class="flex-grow">
                            <label class="text-xs font-medium text-red-600">Destino (Toca el mapa)</label>
                            <input type="text" id="destination-address" placeholder="Esperando selección en el mapa..." class="w-full font-semibold text-gray-800 text-sm bg-red-50 focus:outline-none" readonly>
                            <span id="destination-coords" class="text-xs text-red-500 hidden"></span>
                        </div>
                    </div>
                    <!-- Botón de Pedido -->
                    <button id="request-trip-btn" disabled class="w-full flex items-center justify-center space-x-2 py-3 px-4 bg-indigo-500 text-white font-bold rounded-xl shadow-md disabled:bg-indigo-300 hover:bg-indigo-600 transition duration-150">
                        <i data-lucide="send" class="w-5 h-5"></i>
                        <span>Selecciona Origen y Destino</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Carga de Leaflet JS (se carga al final para asegurar el DOM) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20n63W4ai0B8n7zL8dE5P5wzJbuvjt+YF6r7o/qBCV0=" crossorigin=""></script>
    
    <!-- Script Principal de la Aplicación y Lógica del Mapa -->
    <script type="module">
        // Importaciones de Firebase 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CRÍTICO: Corrección del "rombo" de Leaflet con Data URI (SVG simple)
        if (typeof L !== 'undefined' && L.Icon) {
            delete L.Icon.Default.prototype._getIconUrl;
            const dataUriSvg = 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><circle cx="1" cy="1" r="5" fill="transparent"/></svg>');
            L.Icon.Default.mergeOptions({
                iconUrl: dataUriSvg,
                iconRetinaUrl: dataUriSvg,
                shadowUrl: dataUriSvg,
            });
        }

        let map;
        let originMarker;
        let destinationMarker;
        let currentPosition = null;
        let destinationCoords = null;
        let destinationAddress = '';

        // Global Firebase instances and status
        let db = null;
        let auth = null;
        let isFirebaseReady = false; 

        function displayMessage(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = 'px-4 py-3 font-semibold text-center text-sm border-b shadow-sm';

            statusDiv.classList.remove('bg-red-100', 'text-red-800', 'border-red-200', 'bg-green-100', 'text-green-800', 'border-green-200', 'bg-indigo-100', 'text-indigo-800', 'border-indigo-200');

            if (type === 'error') {
                statusDiv.classList.add('bg-red-100', 'text-red-800', 'border-red-200');
            } else if (type === 'success') {
                statusDiv.classList.add('bg-green-100', 'text-green-800', 'border-green-200');
            } else { // info / default
                statusDiv.classList.add('bg-indigo-100', 'text-indigo-800', 'border-indigo-200');
            }
        }

        const initializeFirebase = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            if (!firebaseConfigRaw) {
                console.warn("Firebase: Configuración NO encontrada. Funciones DB deshabilitadas.");
                displayMessage("⚠️ Mapa cargando. Base de datos (pedidos) desactivada. (Falta Configuración)", 'error');
                isFirebaseReady = false;
                return;
            }

            try {
                const firebaseConfig = JSON.parse(firebaseConfigRaw);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                console.log("Firebase: Inicialización exitosa.");
                isFirebaseReady = true;
                displayMessage("✅ Servicios de pedido listos. Cargando mapa...", 'success');
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                displayMessage("⚠️ Error al conectar la base de datos. Pedidos deshabilitados.", 'error');
                isFirebaseReady = false;
            } finally {
                updateRequestButton();
            }
        };

        window.savePedidoToFirestore = async function(pedidoData) {
            if (!isFirebaseReady || !auth || !auth.currentUser) {
                displayMessage("Error: La base de datos no está disponible. No se pudo enviar el pedido.", 'error');
                return false;
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            try {
                const collectionPath = `artifacts/${appId}/public/data/pedidos`;
                await addDoc(collection(db, collectionPath), {
                    ...pedidoData,
                    userId: auth.currentUser.uid,
                    createdAt: new Date().toISOString(),
                    estado: "PENDIENTE"
                });
                return true;
            } catch (e) {
                console.error("Error guardando el pedido en Firestore: ", e);
                displayMessage("Error al enviar el pedido. Intente de nuevo.", 'error');
                return false;
            }
        };

        function initMap() {
            const mapElement = document.getElementById('map');
            if (!mapElement || typeof L.map !== 'function') {
                console.error("CRÍTICO: El elemento #map o la librería Leaflet no están disponibles.");
                return;
            }

            map = L.map('map').setView([-38.9517, -68.0617], 13); // Centrado inicial
            window.map = map; // Hacemos el mapa global para facilitar la depuración

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            const createCustomIcon = (color) => L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="${color}" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 22 13.5 22 10.2A7.5 7.5 0 0 0 12 3a7.5 7.5 0 0 0-10 7.2c0 3.3 4.7 6.8 10 11.5z"/></svg>`),
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -28]
            });
            const originIcon = createCustomIcon('#3b82f6'); // Azul
            const destinationIcon = createCustomIcon('#ef4444'); // Rojo

            map.locate({ setView: true, maxZoom: 16 });

            map.on('locationfound', (e) => {
                const latlng = e.latlng;
                currentPosition = { lat: latlng.lat, lng: latlng.lng };

                if (originMarker) {
                    originMarker.setLatLng(latlng);
                } else {
                    originMarker = L.marker(latlng, { icon: originIcon }).addTo(map)
                        .bindPopup("Ubicación de Origen (Tú)").openPopup();
                }

                reverseGeocode(latlng, 'origin-display', (address) => {
                    document.getElementById('origin-display').textContent = address;
                    updateRequestButton();
                });
            });

            map.on('locationerror', (e) => {
                console.warn("Error de geolocalización:", e.message);
                const msg = isFirebaseReady ? "✅ Mapa listo. Selecciona Origen manualmente." : "⚠️ DB Offline. Selecciona Origen manualmente.";
                displayMessage(msg, isFirebaseReady ? 'success' : 'error');
            });

            map.on('click', (e) => {
                const latlng = e.latlng;
                destinationCoords = { lat: latlng.lat, lng: latlng.lng };

                if (destinationMarker) {
                    destinationMarker.setLatLng(latlng);
                } else {
                    destinationMarker = L.marker(latlng, { icon: destinationIcon }).addTo(map)
                        .bindPopup("Destino").openPopup();
                }

                reverseGeocode(latlng, 'destination-address', (address) => {
                    destinationAddress = address;
                    document.getElementById('destination-address').value = address;
                    document.getElementById('destination-coords').textContent = `${latlng.lat}, ${latlng.lng}`;
                    updateRequestButton();
                });
            });
        }

        async function reverseGeocode(latlng, elementId, callback) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18&addressdetails=1`;
            
            try {
                const response = await fetch(url, { headers: { 'User-Agent': 'TaxiDelValleApp' } });
                const data = await response.json();
                const address = data.display_name || `Lat: ${latlng.lat.toFixed(4)}, Lon: ${latlng.lng.toFixed(4)}`;
                callback(address);
            } catch (error) {
                callback(`Lat: ${latlng.lat.toFixed(4)}, Lon: ${latlng.lng.toFixed(4)}`);
            }
        }

        function updateRequestButton() {
            const btn = document.getElementById('request-trip-btn');
            const isReadyToRequest = currentPosition && destinationCoords;
            
            if (isReadyToRequest) {
                if (isFirebaseReady) {
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i><span> Solicitar Viaje Ahora</span>';
                    btn.classList.replace('disabled:bg-indigo-300', 'bg-indigo-500');
                    btn.classList.add('hover:bg-indigo-600');
                } else {
                    btn.disabled = true;
                    btn.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i><span> DB Desactivada. Pedido NO disponible.</span>';
                    btn.classList.add('disabled:bg-indigo-300');
                    btn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
                }
            } else {
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="send" class="w-5 h-5"></i><span> Selecciona Origen y Destino</span>';
                btn.classList.add('disabled:bg-indigo-300');
                btn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            function checkAndInitMap() {
                if (typeof L !== 'undefined' && typeof L.map === 'function') {
                    
                    initMap();
                    console.log("Leaflet: Mapa creado. Iniciando bucle de forzado de tamaño...");

                    // CRÍTICO: Bucle de invalidación forzada con requestAnimationFrame
                    let attempts = 0;
                    const maxAttempts = 100; // Intentaremos hasta 100 frames
                    const mapElement = document.getElementById('map');

                    const forceResize = () => {
                        if (map && attempts < maxAttempts) {
                            map.invalidateSize({ pan: false });
                            
                            // Si el contenedor ya tiene un ancho, es probable que esté bien.
                            if (mapElement && mapElement.offsetWidth > 0 && mapElement.offsetHeight > 0) {
                                console.log(`Leaflet: invalidateSize() confirmado y exitoso en intento ${attempts}.`);
                                // Terminamos el bucle aquí
                            } else {
                                attempts++;
                                // Si no está listo, intentamos de nuevo en el próximo frame de animación
                                requestAnimationFrame(forceResize);
                            }
                        }
                    };

                    // Damos un respiro inicial y luego iniciamos el bucle de resize
                    setTimeout(() => {
                        requestAnimationFrame(forceResize);
                    }, 50); 
                    
                } else {
                    // Reintenta la inicialización si la librería no está lista.
                    setTimeout(checkAndInitMap, 50); 
                }
            }
            
            // CRÍTICO - CAMBIO APLICADO: Retrasamos la inicialización del mapa (checkAndInitMap) 
            // 200ms para asegurar que el DOM y el CSS de la altura ya estén aplicados.
            setTimeout(checkAndInitMap, 200);

            document.getElementById('locate-me-btn').addEventListener('click', () => {
                if (map) {
                    map.locate({ setView: true, maxZoom: 16 });
                }
            });

            document.getElementById('request-trip-btn').addEventListener('click', async () => {
                if (!currentPosition || !destinationCoords || !isFirebaseReady) {
                    return;
                }

                const pedidoData = {
                    origen_lat: currentPosition.lat,
                    origen_lng: currentPosition.lng,
                    origen_address: document.getElementById('origin-display').textContent,
                    destino_lat: destinationCoords.lat,
                    destino_lng: destinationCoords.lng,
                    destino_address: destinationAddress,
                    cliente_ref: auth?.currentUser?.uid || 'anonimo',
                    timestamp: new Date().toISOString(),
                };

                const success = await window.savePedidoToFirestore(pedidoData);

                if (success) {
                    displayMessage('✅ ¡Pedido enviado con éxito! Buscando chofer...', 'success');
                    document.getElementById('request-trip-btn').disabled = true;
                    document.getElementById('request-trip-btn').innerHTML = 'Pedido Enviado. Esperando Asignación...';
                }
            });
        });
    </script>
</body>
</html>
