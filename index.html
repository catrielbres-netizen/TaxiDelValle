<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido de Taxi del Valle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- FORMATO CONGELADO: NO MODIFICAR --- */
        body { font-family: 'Inter', sans-serif; }
        .btn-disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }
        .btn-active { background-color: #FBBF24; color: #1F2937; cursor: pointer; opacity: 1; transition: background-color 0.2s; }
        .btn-active:hover:not(:disabled) { background-color: #F59E0B; }
        .search-results { position: absolute; width: 100%; background: white; border: 1px solid #ddd; border-top: none; z-index: 10; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .result-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .result-item:hover { background-color: #f5f5f5; }
        .result-item:last-child { border-bottom: none; }
        /* --- FIN DE FORMATO CONGELADO --- */
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex items-start justify-center">

    <div id="appContainer" class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 md:p-8 mt-4">

        <!-- Header: Formato Taxi del Valle (Congelado) -->
        <header class="bg-amber-500 text-white p-4 rounded-lg mb-6 shadow-md">
            <h1 class="text-3xl font-extrabold text-center text-gray-900">
                Taxi del Valle
            </h1>
        </header>
        
        <h2 class="text-xl font-bold text-gray-900 mb-4 text-center">
            Completa tu Origen y Destino
        </h2>

        <!-- Formulario (Congelado) -->
        <form id="rideForm" class="space-y-4">
            
            <!-- Origen -->
            <fieldset class="border p-4 rounded-lg">
                <legend class="text-sm font-semibold text-gray-700 px-2">1. Origen (Tú)</legend>
                <div class="relative">
                    <label for="origen_search" class="block text-sm font-medium text-gray-700 mb-1">Buscar Dirección de Origen (en Rawson) <span class="text-red-500">*</span></label>
                    <input type="text" id="origen_search" placeholder="Escribe tu calle, altura o lugar..." class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500">
                    <div id="origen_results" class="search-results hidden"></div>
                </div>
                <div class="mt-4">
                    <label for="origen" class="block text-sm font-medium text-gray-700 mb-1">Origen Seleccionado</label>
                    <input type="text" id="origen" name="origen" disabled required placeholder="Busca tu dirección de origen..." class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100">
                    <input type="hidden" id="origen_lat" name="origen_lat">
                    <input type="hidden" id="origen_lon" name="origen_lon">
                </div>
                <div class="mt-4">
                    <label for="origen_description" class="block text-sm font-medium text-gray-700 mb-1">Descripción de Ubicación (Ej: Frente al árbol)</label>
                    <input type="text" id="origen_description" name="origen_description" placeholder="Detalles para que el chofer te ubique fácilmente." class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500">
                </div>
            </fieldset>

            <!-- Destino -->
            <fieldset class="border p-4 rounded-lg">
                <legend class="text-sm font-semibold text-gray-700 px-2">2. Destino</legend>
                <div class="relative">
                    <label for="destino_search" class="block text-sm font-medium text-gray-700 mb-1">Buscar Dirección de Destino <span class="text-red-500">*</span></label>
                    <input type="text" id="destino_search" placeholder="Escribe una calle, altura o lugar..." class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500">
                    <div id="destino_results" class="search-results hidden"></div>
                </div>
                <div class="mt-4">
                    <label for="destino" class="block text-sm font-medium text-gray-700 mb-1">Destino Seleccionado</label>
                    <input type="text" id="destino" name="destino" required disabled placeholder="Busca una dirección..." class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100">
                    <input type="hidden" id="destino_lat" name="destino_lat">
                    <input type="hidden" id="destino_lon" name="destino_lon">
                </div>
            </fieldset>
            
            <!-- Estimación (Congelado) -->
            <div id="estimationBox" class="bg-blue-100 p-4 rounded-lg shadow-inner hidden">
                <h3 class="font-bold text-lg text-blue-800 mb-2">Estimación del Viaje</h3>
                <p class="text-sm text-gray-700"><strong class="text-blue-600">Tiempo Estimado:</strong> <span id="estimatedTime" class="font-medium">--</span></p>
                <p class="text-sm text-gray-700"><strong class="text-blue-600">Precio Estimado:</strong> <span id="estimatedPrice" class="font-medium text-xl">--</span></p>
            </div>

            <!-- Campos Opcionales (Congelado) -->
            <div class="flex space-x-4">
                <div class="w-1/2">
                    <label for="pasajeros" class="block text-sm font-medium text-gray-700 mb-1">Pasajeros</label>
                    <input type="number" id="pasajeros" name="pasajeros" value="1" min="1" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500">
                </div>
                <div class="w-1/2">
                    <label for="pago" class="block text-sm font-medium text-gray-700 mb-1">Método de Pago</label>
                    <select id="pago" name="pago" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500">
                        <option value="cash">Efectivo</option>
                        <option value="card">Tarjeta (Simulado)</option>
                    </select>
                </div>
            </div>
            
            <!-- Botón de Envío (Congelado) -->
            <button type="submit" id="submitButton" disabled class="w-full mt-6 py-3 px-4 rounded-lg text-gray-900 font-semibold shadow-xl transition duration-200 ease-in-out btn-disabled">
                <span id="buttonText">Selecciona Origen y Destino</span>
            </button>
        </form>
    </div>

    <!-- Modal de Mensajes (Congelado) -->
    <div id="messageBox" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="messageContent" class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center"></div>
    </div>
    
    <script type="module">
        // === CONFIGURACIÓN DE APIS ===
        const TOMTOM_API_KEY = "Z22u8H0ZF80TlLq9c7b0nlXL2P3jESQZ";
        
        // --- ¡CONFIGURACIÓN DE APPSHEET COMPLETA! ---
        const APPSHEET_APP_ID = "24f8735e-447a-48cd-a503-7deb1149c3ba"; // <-- ¡ID Actualizado!
        const APPSHEET_ACCESS_KEY = "V2-R5pzi-2brtL-KObNl-nPiDe-GIxT9-4PiuP-l72L4-KrkOd"; // <-- ¡Clave Actualizada!
        const APPSHEET_TABLE_NAME = "Pedidos"; // Asegúrate que este sea el nombre exacto de tu tabla
        // ---------------------------------------------------

        let APPSHEET_API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_APP_ID}/tables/${APPSHEET_TABLE_NAME}/Action`;

        const RAWSON_COORDS = { lat: -43.3002, lon: -65.1023 };
        
        let originCoords = null; 
        let destinationCoords = null; 
        
        // === REFERENCIAS DEL DOM (Congeladas) ===
        const form = document.getElementById('rideForm');
        const submitButton = document.getElementById('submitButton');
        const buttonText = document.getElementById('buttonText');
        const origenSearchInput = document.getElementById('origen_search');
        const origenResultsContainer = document.getElementById('origen_results');
        const origenInput = document.getElementById('origen');
        const origenLatInput = document.getElementById('origen_lat');
        const origenLonInput = document.getElementById('origen_lon');
        const destinoSearchInput = document.getElementById('destino_search');
        const destinoResultsContainer = document.getElementById('destino_results');
        const destinoInput = document.getElementById('destino');
        const destinoLatInput = document.getElementById('destino_lat');
        const destinoLonInput = document.getElementById('destino_lon');
        const estimationBox = document.getElementById('estimationBox');
        const estimatedTime = document.getElementById('estimatedTime');
        const estimatedPrice = document.getElementById('estimatedPrice');
        
        // --- Utilidades (Congelado) ---
        const showMessage = (title, text, isError = false) => {
            document.getElementById('messageContent').innerHTML = `
                <h2 class="text-xl font-bold mt-3 ${isError ? 'text-red-600' : 'text-gray-900'}">${title}</h2>
                <p class="text-gray-600 mt-2">${text}</p>
                <button onclick="window.closeMessage()" class="mt-4 py-2 px-4 bg-amber-500 text-gray-900 font-semibold rounded-lg hover:bg-amber-600 transition">Aceptar</button>
            `;
            document.getElementById('messageBox').classList.remove('hidden');
            document.getElementById('messageBox').classList.add('flex');
        };
        window.closeMessage = () => { document.getElementById('messageBox').classList.add('hidden'); document.getElementById('messageBox').classList.remove('flex'); };
        const debounce = (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; };
        
        // --- Lógica de Búsqueda (Congelada) ---
        const setOrigin = (coords, address) => {
            originCoords = coords;
            origenLatInput.value = coords.lat;
            origenLonInput.value = coords.lon;
            origenInput.value = address; 
            origenSearchInput.value = ''; 
            origenResultsContainer.classList.add('hidden');
            calculateRouteAndEstimate();
        };
        const setDestination = (coords, address) => {
            destinationCoords = coords;
            destinoLatInput.value = coords.lat;
            destinoLonInput.value = coords.lon;
            destinoInput.value = address;
            destinoSearchInput.value = ''; 
            destinoResultsContainer.classList.add('hidden');
            calculateRouteAndEstimate();
        };
        const searchTomTomApi = async (query) => {
            try {
                let url = `https://api.tomtom.com/search/2/search/${encodeURIComponent(query)}.json?key=${TOMTOM_API_KEY}&language=es-ES&limit=5&lat=${RAWSON_COORDS.lat}&lon=${RAWSON_COORDS.lon}&radius=50000`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Respuesta de red no fue ok.');
                return await response.json();
            } catch (error) {
                console.warn("Error en API de Búsqueda TomTom:", error);
                return { results: [] }; 
            }
        };
        const handleOriginSearch = async () => { const q = origenSearchInput.value; if (q.length < 3) { origenResultsContainer.classList.add('hidden'); return; } const d = await searchTomTomApi(q); if (d && d.results) displaySearchResults(d.results, origenResultsContainer, setOrigin); else origenResultsContainer.classList.add('hidden'); };
        const handleDestinationSearch = async () => { const q = destinoSearchInput.value; if (q.length < 3) { destinoResultsContainer.classList.add('hidden'); return; } const d = await searchTomTomApi(q); if (d && d.results) displaySearchResults(d.results, destinoResultsContainer, setDestination); else destinoResultsContainer.classList.add('hidden'); };
        const displaySearchResults = (results, container, selectCallback) => {
            container.innerHTML = '';
            if (results.length === 0) { container.classList.add('hidden'); return; }
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.textContent = result.address.freeformAddress;
                item.dataset.lat = result.position.lat;
                item.dataset.lon = result.position.lon;
                item.dataset.address = result.address.freeformAddress;
                item.addEventListener('click', () => {
                    selectCallback({ lat: parseFloat(item.dataset.lat), lon: parseFloat(item.dataset.lon) }, item.dataset.address);
                });
                container.appendChild(item);
            });
            container.classList.remove('hidden');
        };

        // --- Lógica de Estimación (Congelada) ---
        const calculateRouteAndEstimate = async () => {
            if (!originCoords || !destinationCoords) { estimationBox.classList.add('hidden'); checkButtonState(); return; }
            estimationBox.classList.remove('hidden');
            estimatedTime.textContent = 'Calculando...'; estimatedPrice.textContent = 'Calculando...';
            try {
                const locations = `${originCoords.lon},${originCoords.lat}:${destinationCoords.lon},${destinationCoords.lat}`;
                const url = `https://api.tomtom.com/routing/1/calculateRoute/${locations}/json?key=${TOMTOM_API_KEY}&computeBestOrder=false&travelMode=taxi`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Respuesta de red no fue ok.');
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0].summary;
                    const distanceMeters = route.lengthInMeters;
                    const timeSeconds = route.travelTimeInSeconds;
                    const distanceKm = distanceMeters / 1000;
                    const basePrice = 500.00; const ratePerKm = 150.00; 
                    const finalPrice = (basePrice + (distanceKm * ratePerKm)).toFixed(2);
                    const timeMinutes = Math.ceil(timeSeconds / 60);
                    const timeString = `${timeMinutes} min`;
                    estimatedTime.textContent = timeString;
                    estimatedPrice.textContent = `$${finalPrice}`;
                } else { throw new Error("No se encontraron rutas."); }
            } catch (error) {
                console.warn("Error en API de Rutas, usando simulación:", error);
                const finalPrice = (Math.random() * 1000 + 500).toFixed(2);
                const timeString = `${Math.floor(Math.random() * 15 + 5)} min`;
                estimatedTime.textContent = timeString; estimatedPrice.textContent = `$${finalPrice}`;
            }
            checkButtonState();
        };
        
        // --- Lógica de Botón (Congelada) ---
        const checkButtonState = () => {
            const isOriginSet = !!originCoords;
            const isDestinationSet = !!destinationCoords;
            const isPriceCalculated = estimatedTime.textContent !== '--' && !estimatedTime.textContent.includes('Calculando');
            const isValid = isOriginSet && isDestinationSet && isPriceCalculated;
            submitButton.disabled = !isValid;
            if (isValid) {
                submitButton.classList.remove('btn-disabled'); submitButton.classList.add('btn-active');
                buttonText.textContent = `Pedir Taxi - ${estimatedPrice.textContent}`;
            } else {
                submitButton.classList.remove('btn-active'); submitButton.classList.add('btn-disabled');
                if (!isOriginSet) { buttonText.textContent = 'Escribe tu dirección de origen'; }
                else if (!isDestinationSet) { buttonText.textContent = 'Selecciona o busca un destino'; }
                else if (!isPriceCalculated) { buttonText.textContent = 'Calculando precio...'; }
                else { buttonText.textContent = 'Completa la información'; }
            }
        };

        // --- Función de Envío a APPSHEET (Congelada) ---
        const handleSubmit = async (e) => {
            e.preventDefault(); 
            if (submitButton.disabled) { showMessage("Error", "Asegúrate de tener un origen y un destino seleccionado.", true); return; }
            
            if (APPSHEET_APP_ID === "TU_APP_ID_AQUI" || !APPSHEET_APP_ID) {
                showMessage("Error de Configuración", "La app no está conectada a AppSheet. Falta el APP_ID del desarrollador.", true);
                return;
            }
            
            submitButton.disabled = true;
            buttonText.textContent = 'Enviando Solicitud...';
            submitButton.classList.add('opacity-70', 'animate-pulse');

            APPSHEET_API_URL = `https://api.appsheet.com/api/v2/apps/${APPSHEET_APP_ID}/tables/${APPSHEET_TABLE_NAME}/Action`;

            const newRowData = {
                "ID_Pedido": `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`, 
                "origen_lat": originCoords.lat,
                "origen_lon": originCoords.lon,
                "destino_lat": destinationCoords.lat,
                "destino_lon": destinationCoords.lon,
                "origen_address": origenInput.value,
                "origen_description": document.getElementById('origen_description').value,
                "destino_address": destinoInput.value,
                "pasajeros": document.getElementById('pasajeros').value,
                "pago_method": document.getElementById('pago').value,
                "estimated_time": estimatedTime.textContent,
                "estimated_price": estimatedPrice.textContent,
                "status": "pending",
                "createdAt": new Date().toISOString(),
            };
            
            try {
                const response = await fetch(APPSHEET_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'ApplicationAccessKey': APPSHEET_ACCESS_KEY
                    },
                    body: JSON.stringify({
                        "Action": "Add", 
                        "Properties": { "Locale": "es-ES" },
                        "Rows": [ newRowData ] 
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error de AppSheet (${response.status}): ${errorText}`);
                }
                
                showMessage("¡Pedido Enviado!", `Tu taxi está siendo buscado. Precio: ${estimatedPrice.textContent}.`);
                
                // Resetear UI
                destinationCoords = null; originCoords = null;
                origenInput.value = ""; origenSearchInput.value = ""; origenLatInput.value = ""; origenLonInput.value = "";
                destinoInput.value = ""; destinoSearchInput.value = ""; destinoLatInput.value = ""; destinoLonInput.value = "";
                document.getElementById('origen_description').value = ""; document.getElementById('pasajeros').value = "1";
                estimationBox.classList.add('hidden');
                
            } catch (error) {
                console.error("Error al enviar el pedido a AppSheet:", error);
                showMessage("Error de Envío", `Hubo un error al guardar tu pedido. Detalles: ${error.message}`, true);
            } finally {
                submitButton.classList.remove('opacity-70', 'animate-pulse');
                checkButtonState(); 
            }
        };

        // --- Lógica de Carga (Congelada) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM listo. App de cliente iniciada (Modo API AppSheet).");
            origenSearchInput.addEventListener('input', debounce(handleOriginSearch, 350));
            destinoSearchInput.addEventListener('input', debounce(handleDestinationSearch, 350));
            document.addEventListener('click', (e) => {
                if (e.target.id !== 'origen_search') origenResultsContainer.classList.add('hidden');
                if (e.target.id !== 'destino_search') destinoResultsContainer.classList.add('hidden');
            });
            form.addEventListener('submit', handleSubmit);
            document.getElementById('origen_description').addEventListener('input', checkButtonState);
        });
        
    </script>
</body>
</html>
